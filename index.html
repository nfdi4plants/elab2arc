<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="elab2ARC, convert eLabFTW experiments to ARCs">
  <meta name="keywords" content="elab2ARC">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" type="image/x-icon" href="favicon.png">
  <style>
video {
  width: 100%;
  height: auto;
}
  </style>
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/custom0929.css" rel="stylesheet" />
  <link href="./css/bs5-intro-tour.css" rel="stylesheet" />
  <link href="./css/MEMfsGUI0929.css" rel="stylesheet" />
  <link href="./css/elabGUI1305.css" rel="stylesheet" />

  <!-- Diff2html for version comparison -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />

</head>

<body>
  <nav class="navbar  navbar-expand-lg navbar-dark fixed-top border-0 mb-3"
    style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">

    <div class=" container-fluid " style=" height: 3.25rem;  ">
      <a class="" href="https://nfdi4plants.org/" style="">
        <img src="images/logo.png" alt="Logo" width="32" height="32"
          style=" margin: 8px 20px 8px 12px; left: 0px; padding-top: 4px;" />
      </a>



      <button type="button" name="navBtn" onclick="location.href=location.href.split('#')[0]+'#elab'"
        class="btn d-none  nav-linkc px-3" id="submitNavBtn">
        Fetch eLabFTW &nbsp;
      </button>


      <button type="button" name="navBtn" aria-current="homeTab"
        onclick="window.history.pushState('', '', '/elab2arc/#home'); showTab('homeTab')" class="nav-linkc px-3"
        id="homeBtn">
        Home&nbsp;
      </button>
      <button type="button" name="navBtn" aria-current="elabftwTab"
        onclick="window.history.pushState('', '', '/elab2arc/#elabftw'); showTab('elabftwTab')" class="nav-linkc px-3"
        id="elabftwBtn">
        eLabFTW&nbsp;<span id="elabFTWCheck">&#127760;</span>
      </button>


      <button type="button" name="navBtn" data-bs-toggle="offcanvas" data-bs-target="#elabPreviewCanvas"
        aria-controls="elabPreviewCanvas" class="nav-linkc px-3 d-none" id="ftwBtn">
        elabFTW&nbsp;
      </button>

      <button type="button" name="navBtn"
        onclick="window.history.pushState('', '', '/elab2arc/#arc'); showTab( 'arcTab')" class="nav-linkc px-3"
        id="arcBtn">
        ARCs&nbsp;<span id="arcCheck">&#127760;</span>
      </button>

      <button type="button" name="navBtn" onclick="location.href=location.href.split('#')[0]+'#token'"
        class="nav-linkc px-3" id="tokenBtn">
        Tokens&nbsp;
      </button>


      <span class="ms-auto">
        <a id="kblink" class="p-2  nav-linkc" target="_blank"
          href="https://nfdi4plants.github.io/nfdi4plants.knowledgebase/resources/elab2arc/"><img
            src="images/knowledgebase.png" alt="DataPLANT knowledgebase" style="width:2rem;height:2rem;"> Help</a>




        <a id="ghlink" class=" p-2 nav-linkc" target="_blank" href="https://github.com/nfdi4plants/elab2arc"><img
            src="images/github-mark-white.png" alt="Elab2ARC GitHub URL" style="width:2rem;height:2rem;"> Github</a>
      </span>
    </div>

  </nav>
  <main class="container-xxl" style="padding-top: 4.25rem;">
    <div name="tab" class=" col-12 justify-content-center d-none text-center" id="homeTab">
      <h1 class="text-center">
        elab2ARC
      </h1>
      <h4 class="text-center">
        <span class="d-none">¬†Tool for converting eLabFTW experiment data into ARC (Annotated Research Context)
          format</span>
        Here's a concise one-minute tutorial animation explaining how to convert eLabFTW entries into ARCs with just a
        few clicks using elab2arc:
      </h4>
      <video controls >

        <source src="https://raw.githubusercontent.com/nfdi4plants/elab2arc/refs/heads/main/images/elab2arc_with_token_generation.mp4" type="video/mp4" />

      </video>


    </div>


    <div name="tab" class="justify-content-center align-items-center" id="elabftwTab">

      <h2 class="text-center">Please choose your eLabFTW experiments or resources</h2>

      <div class="justify-content-center align-items-center mt-1" >
        <div class="col-lg-12">
          <div class="rounded border" style="height:60vh; overflow-y: scroll">

            <table class="table table-striped table-hover border-0 overflow-hidden"
              style="table-layout:auto ; width:100%; ">
              <thead class="align-middle">
                <tr>
                  <th scope="col">Type</th>
                  <th scope="col">ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                  <th scope="col">Name
                    <input class="" type="search" id="elabSearch" placeholder="Search">
                    <button id="elabSearchBtn" class="btn btn-sm"
                      onclick="updateelabList(document.getElementById('elabSearch').value)">Search</button>
                    <button id="elabSearchResetBtn" class="btn btn-sm" onclick="fillElabTable()">Reset</button>
                  </th>
                  <th scope="col">Creation Date</th>
                  <th scope="col">Author</th>
                  <th scope="col">Selection/Preview</th>
                </tr>
              </thead>
              <tbody id="elabTable">
                <tr>
                  <th></th>
                  <td> No eLabFTW experiments/resources available. Use <a href="#token">Token tab</a> to add an eLabFTW
                    API key</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>

              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="border row text-center p-3 mt-1  convert-container rounded justify-content-center align-items-end ">
        <div class="col-lg-3 ">
          <label for="elabExperimentid" class="form-label">
            <button class="border-0 bg-white text-success " type="button" data-bs-toggle="offcanvas"
              data-bs-target="#experimentIdCanvas" aria-controls="experimentIdCanvas">
              Selected eLabFTW Experiment ID &#128712;</button>
          </label>
          <textarea type="text" name="elabid" class="form-control " autocomplete="username" id="elabExperimentid"
            aria-describedby="elabexpHelp" onchange="elabCheckSync();elabListSync()"></textarea>
          <div id="elabexpHelp" class="form-text d-none">Experiment ID can be found in the address bar of the browser.
          </div>
        </div>
        <div class="col-lg-3 ">
          <label for="elabResourceid" class="form-label">
            <button class="border-0 bg-white text-success " type="button" data-bs-toggle="offcanvas"
              data-bs-target="#experimentIdCanvas" aria-controls="experimentIdCanvas">
              Selected eLabFTW Resource ID &#128712;</button>
          </label>
          <textarea type="text" name="elabid" class="form-control " autocomplete="username" id="elabResourceid"
            aria-describedby="elabresourceHelp" onchange="elabCheckSync();elabListSync()"></textarea>
          <div id="elabresourceHelp" class="form-text d-none">Experiment ID can be found in the address bar of the
            browser.
          </div>
        </div>
       
        <div class="col-lg-3 ">
          <label for="elabsubmit" class="form-label my-3 d-none">Submit Options</label>
          <button class="btn btn-primary my-3 w-100 d-none" type="submit" data-bs-toggle="collapse"
            data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus"> One Click Submission
          </button>

          <button class="btn btn-primary w-100" type="button" onclick="showTab('arcTab')"><span> Confirm eLabFTW
              Selection</span></button>

          <div id="toolstatus" class="col-10 m-auto">
          </div>
        </div>

      </div>

    </div>

    </div>
    <div name="tab" class="justify-content-center" id="tokenTab">
      <h1 class="center"> Please select your eLabFTW instance and enter your tokens </h1>




      <div class="row justify-content-center align-items-end">
        <div class="my-3 col-lg-8 ">
          <label for="elabURLInput1" class="form-label">

            <button class="border-0 bg-white text-success" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#instanceCanvas" aria-controls="instanceCanvas">
              eLabFTW Instance&nbsp;&#128712; (click me to learn more)</button>

          </label>
          <br>
          <button class="btn btn-primary dropdown-toggle" id="elabURLInput1" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            eLabFTW Instance: HHU
          </button>
          <ul class="dropdown-menu">
            <li><button class="dropdown-item" onclick="setelabURL('https://elab.dataplan.top/api/v2/')"
                type="button">eLabFTW Instance: DataPLANT</button></li>
            <li><button class="dropdown-item d-none" onclick="setelabURL('https://demo.elabftw.net/api/v2/')"
                type="button">eLabFTW Instance: Demo</button></li>
            <li><button class="dropdown-item" onclick="setelabURL('https://elabftw.hhu.de/api/v2/')"
                type="button">eLabFTW Instance: HHU</button></li>
            <li>&nbsp;&nbsp;&nbsp;Add&nbsp;instance:&nbsp;<input type="text" id="customElab"
                onchange="setelabURL(this.value)"
                placeholder=" https://elabftw/api/v2/"><br>&nbsp;&nbsp;&nbsp;For&nbsp;example:&nbsp;"https://elabftw.test.hhu.de/api/v2"
            </li>
          </ul>

        </div>
      </div>
      <div class="row justify-content-center align-items-end">
        <div class="my-3 col-lg-8 ">
          <label for="elabToken" class="form-label">

            <button class="border-0 bg-white text-success" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#elabTokenCanvas" aria-controls="elabTokenCanvas">
              eLabFTW API Key&nbsp;&#128712; (click me to learn more)</button>
          </label>
          <div class="input-group mb-3">
            <input type="password" onchange="initCookies();" name="elabtoken" class="form-control"
              autocomplete="password" id="elabToken" required />
            <button class="btn btn-secondary" type="button" name="togglePassword" data-show-id="elabtoken"
              onclick=" document.getElementById('elabToken').value = '20-b8e2485c173f8d8f8893bc7806f37847625d0c922c4ff7cc6b9cecf10b34035f7a243366ccd50a659c9320'; initCookies(); "
              title="Load demo/test API key for eLabFTW">
              get a test api key
            </button>
            <button class="btn btn-secondary" type="button" name="togglePassword" data-show-id="elabToken"
              onclick="showPassword(this)">
              üëÅÔ∏è
            </button>
          </div>
        </div>
      </div>
      <div class="row justify-content-center align-items-end">
        <div class="my-3 col-lg-8">
          <label for="datahubToken" class="form-label">
            <button class="border-0 bg-white text-success" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#datahubTokenCanvas" aria-controls="datahubTokenCanvas">
              DataHub Token&nbsp;&#128712; (click me to learn more)</button>

          </label>

          <div class="input-group mb-3">
            <input type="password" onchange="initCookies();" name="datahubtoken" class="form-control" autocomplete="new-password"
              id="datahubToken" required />
            <button class="btn btn-secondary" type="button" name="togglePassword" data-show-id="datahubToken"
              onclick="location.href='https://datahublogin.dataplan.top/auth/gitlab'">
              get a token
            </button>
            <button class="btn btn-secondary" type="button" name="togglePassword" data-show-id="datahubToken"
              onclick="showPassword(this)">
              üëÅÔ∏è
            </button>
          </div>
        </div>
      </div>

      <div class="row justify-content-center align-items-end d-none" id="togetherAPIKeyContainer">
        <div class="my-3 col-lg-8">
          <label for="togetherAPIKey" class="form-label">
            Together.AI API Key (for LLM Datamap Generation)
          </label>
          <div class="input-group mb-3">
            <input type="password" onchange="initCookies();" name="togetherAPIKey" class="form-control" autocomplete="new-password"
              id="togetherAPIKey" placeholder="Enter Together.AI API key" />
            <button class="btn btn-secondary" type="button" name="togglePassword" data-show-id="togetherAPIKey"
              onclick="showPassword(this)">
              üëÅÔ∏è
            </button>
          </div>

          <label for="togetherAIModel" class="form-label mt-2">
            Primary LLM Model
          </label>
          <select class="form-select" id="togetherAIModel" onchange="saveModelSelection()">
            <optgroup label="Meta Llama Models">
              <option value="meta-llama/Llama-3.2-3B-Instruct-Turbo">
                Llama 3.2 3B Turbo (8K context)
              </option>
              <option value="meta-llama/Llama-3.3-70B-Instruct-Turbo-Free">
                Llama 3.3 70B Turbo (131K context)
              </option>
            </optgroup>
            <optgroup label="OpenAI Models">
              <option value="openai/gpt-oss-20b">
                OpenAI GPT OSS 20B (16K context)
              </option>
              <option value="openai/gpt-oss-120b">
                OpenAI GPT OSS 120B (32K context)
              </option>
            </optgroup>
            <optgroup label="Other Models">
              <option value="Qwen/Qwen3-235B-A22B-Instruct-2507-tput" selected>
                Qwen 3 235B A22B (131K context, recommended)
              </option>
              <option value="google/gemma-3n-E4B-it">
                Google Gemma 3n E4B (32K context)
              </option>
              <option value="lgai/exaone-deep-32b">
                LG EXAONE Deep 32B (32K context)
              </option>
              <option value="ServiceNow-AI/Apriel-1.5-15b-Thinker">
                ServiceNow Apriel 1.5 15B Thinker (32K context)
              </option>
              <option value="deepseek-ai/DeepSeek-R1-Distill-Llama-70B-free">
                DeepSeek R1 Distill 70B (64K context)
              </option>
            </optgroup>
          </select>
          <small class="form-text text-muted">
            Primary model for protocol analysis
          </small>

          <label for="togetherAIFallbackModels" class="form-label mt-3">
            Fallback Models (for rate limits)
          </label>
          <select class="form-select" id="togetherAIFallbackModels" multiple size="8" onchange="saveFallbackModelSelection()">
            <optgroup label="Meta Llama Models">
              <option value="meta-llama/Llama-3.2-3B-Instruct-Turbo">
                Llama 3.2 3B Turbo (8K context)
              </option>
              <option value="meta-llama/Llama-3.3-70B-Instruct-Turbo-Free">
                Llama 3.3 70B Turbo (131K context)
              </option>
            </optgroup>
            <optgroup label="OpenAI Models">
              <option value="openai/gpt-oss-20b">
                OpenAI GPT OSS 20B (16K context)
              </option>
              <option value="openai/gpt-oss-120b" selected>
                OpenAI GPT OSS 120B (32K context)
              </option>
            </optgroup>
            <optgroup label="Other Models">
              <option value="Qwen/Qwen3-235B-A22B-Instruct-2507-tput" selected>
                Qwen 3 235B A22B (262K context, recommended)
              </option>
              <option value="google/gemma-3n-E4B-it" selected>
                Google Gemma 3n E4B (32K context)
              </option>
              <option value="lgai/exaone-deep-32b" selected>
                LG EXAONE Deep 32B (32K context)
              </option>
              <option value="ServiceNow-AI/Apriel-1.5-15b-Thinker">
                ServiceNow Apriel 1.5 15B Thinker (32K context)
              </option>
              <option value="deepseek-ai/DeepSeek-R1-Distill-Llama-70B-free">
                DeepSeek R1 Distill 70B (64K context)
              </option>
            </optgroup>
          </select>
          <small class="form-text text-muted">
            Hold Ctrl/Cmd to select multiple. These models will be tried if primary hits rate limit.
          </small>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="llmTestModeSwitch" onchange="saveLLMTestMode()">
            <label class="form-check-label" for="llmTestModeSwitch">
              <strong>Test Mode</strong> - Use sample data instead of API calls
            </label>
            <br>
            <small class="form-text text-muted">
              Enable this to test ISA generation without consuming API credits. Uses predefined E. coli sequencing workflow.
            </small>
          </div>
        </div>
      </div>

      <div class="row justify-content-center align-items-end">
        <div class="my-3 col-lg-8">
          <button class="btn btn-primary" onclick="initCookies();redirect();" type="button"> Save

          </button>
        </div>
      </div>
    </div>

    </div>

    <div name="tab" class="justify-content-center" id="arcTab">

      <h2 class="text-center">Please choose your ARC</h2>

      <div class="rounded border " style="height:60vh; overflow-y: scroll">

        <table class="table table-striped table-hover border-0 overflow-hidden"
          style="table-layout:auto ; width:100%; ">
          <thead class="align-middle">
            <tr>
              <th scope="col">Number</th>
              <th scope="col">Repo Name <span class="" role="search">
                  <input class="" type="search" id="arcSearch" placeholder="Search" aria-label="Search">
                  <button id="arcSearchBtn" class="btn btn-sm"
                    onclick="updateARCList(document.getElementById('arcSearch').value)">Search</button>
                  <button id="arcSearchResetBtn" class="btn btn-sm" onclick="updateARCList('')">Reset</button>
                </span> </th>
              <th scope="col">Link &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
              <th scope="col">Select the target ARC directory &nbsp;&nbsp;&nbsp;&nbsp;</th>
            </tr>
          </thead>
          <tbody id="userProjectsTable">
            <tr>
              <th></th>
              <td> No ARC available. Use <a href="#home">home tab</a> to start a conversion</td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="">
        <div class="col-12">

          <div class="border row text-center p-3 mt-1 convert-container rounded">
            <div class="lead col-3" id="elabFTWInfo"> eLabFTW IDs
              <div id="elabExpInfo"></div>
              <div id="elabResInfo"></div>

            </div>

            <div class=" text-success col-1" id=""> ====>>> </div>
            <div class=" col-3">
              <span class=" lead" id="gitlabInfo"> GitLab URL </span> <br>
              <span class=" lead d-none" id="arcInfo"> Please select your ARC </span>
               <label for="targetPath" class="form-label">
                <br>
            <span class="text-info">Target Path in ARC &#128193;</span>
          </label>
          <input type="text" class="form-control" id="targetPath"
            placeholder="e.g., MyARC/assays/MyAssay or MyARC/studies/MyStudy"
            aria-describedby="targetPathHelp">
          <div id="targetPathHelp" class="form-text">Specify where in the ARC structure your data should be placed. Auto-filled when selecting assay/study.</div>
  
            </div>

             
         
            &nbsp; &nbsp; &nbsp; &nbsp;
            <div class="lead col-4">
              <button type="button" class="btn btn-primary btn-sm" onclick="multiConvert()"> <span class="lead"> Start
                  Conversion</span></button>
              <button type="button" class="btn btn-secondary btn-sm" id="statusModalBtn" data-bs-toggle="modal"
                data-bs-target="#statusModal">
                <span class="lead"> Check Status</span>
              </button>


              <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" id="enableDatamapSwitch" onchange="toggleTogetherAPIKeyField()">
                <label class="form-check-label" for="enableDatamapSwitch">
                  Enable LLM Annotation Table
                </label>
              </div>
              <button type="button" class="btn btn-info btn-sm d-none" id="editPromptBtn" data-bs-toggle="modal" data-bs-target="#promptEditorModal">
                <span class="lead">‚úèÔ∏è Edit Prompt</span>
              </button>
            </div>
          </div>

          <!-- <h4> Imported ARCs </h4>
          <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
            <thead>
              <tr>
                <th scope="col">ARC Name</th>
                <th scope="col">Import Time</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="importedARCTable">
            </tbody>
          </table> -->
        </div>
        <div class="col-7">


        </div>
      </div>



    </div>
    <div name="tab" class=" justify-content-center align-items-center m-auto" id="ftwTab">

    </div>


    <div name="tab" class="  d-none align-items-center m-auto" id="updateTab">

      <div class=" area uploadarea my-3" id="importArea" ondragenter="this.className='area uploadarea dragging'"
        ondrop=";DragAndDrop(event)" style=" width:100%">


        <input type="file" id="import" multiple>
      </div>
      <div class="text-center m-auto">
        <button class="text btn btn-primary d-none" id="toSubmit"
          onclick="location.href=location.href.split('#')[0]+'#submit'">
          Start Submission
        </button>
      </div>
      <div id="alertPlace"> </div>


    </div>

    <button type="button" class="btn btn-primary d-none" id="loadingModalBtn" data-bs-toggle="modal"
      data-bs-target="#loadingModal">
      Launch loading modal
    </button>
    <div class="modal" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="#loadingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="loadingModalLabel">Processing</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-center">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>


            </div>


          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

          </div>
        </div>
      </div>
    </div>



    <button type="button" class="btn btn-primary d-none" id="folderModalBtn" data-bs-toggle="modal"
      data-bs-target="#folderModal">
      Launch folderModal
    </button>
    <div class="modal" id="folderModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-labelledby="#folderModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="folderModalLabel">Select the folder for conversion</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

            <div class="explorer-container">
              <div id="address-bar">
                <button id="back-button">‚Üê</button>
                <span>Address:</span>
                <input type="text" id="current-path" readonly>
                <button id="new-folder-button">üìÅ New Folder</button>
              </div>

              <div class="main-content">
                <div id="sidebar">
                  <div id="fileTree"></div>
                </div>

                <div id="main-area"></div>

                <div id="preview-panel" class="preview-panel" style="display: none;">
                  <div class="preview-header">
                    <h5 id="preview-title">File Preview</h5>
                    <div class="preview-header-actions">
                      <button id="fullscreen-preview" class="btn btn-sm btn-outline-primary me-2" title="Fullscreen Preview">
                        üîç Fullscreen
                      </button>
                      <button id="close-preview" class="btn-close" aria-label="Close Preview"></button>
                    </div>
                  </div>
                  <div class="preview-content" id="preview-content">
                    <!-- Dynamic content will be loaded here -->
                  </div>
                  <div class="preview-actions">
                    <button id="download-file" class="btn btn-sm btn-secondary">Download</button>
                    <button id="save-file" class="btn btn-sm btn-primary" style="display: none;">Save</button>
                  </div>
                </div>
              </div>


            </div>


          </div>

          <!-- Bootstrap Offcanvas for Fullscreen Preview -->
          <div class="offcanvas offcanvas-end" id="preview-offcanvas" style="width: 70vw;" tabindex="-1" aria-labelledby="offcanvas-title">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvas-title">File Preview</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0">
              <div class="offcanvas-content-wrapper h-100 d-flex flex-column">
                <div class="preview-navigation p-2 border-bottom" id="preview-navigation" style="display: none;">
                  <!-- Sheet tabs for Excel files will be added here -->
                </div>
                <div class="offcanvas-content flex-grow-1 p-3 overflow-auto" id="offcanvas-content">
                  <!-- Dynamic content will be loaded here -->
                </div>
                <div class="offcanvas-actions p-3 border-top bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group" role="group">
                      <button id="offcanvas-download" class="btn btn-outline-secondary btn-sm">
                        üíæ Download
                      </button>
                      <button id="offcanvas-save" class="btn btn-outline-primary btn-sm" style="display: none;">
                        üíæ Save
                      </button>
                    </div>
                    <button id="compact-preview" class="btn btn-outline-info btn-sm">
                      üì± Compact View
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="select-button">Select Folder</button>

          </div>
        </div>
      </div>
    </div>

    <!-- eLabFTW Preview Offcanvas -->
    <div class="offcanvas offcanvas-start w-75" tabindex="-1" id="elabPreviewCanvas"
      aria-labelledby="elabPreviewCanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="elabPreviewCanvasLabel">eLabFTW Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="container-fluid mt-3">
          <div class="row g-4">

            <!-- Main Content -->
            <div class="col-md-9">

              <section class="section title bg-light rounded p-3 mb-4">
                <h1 id="expTitle" class="text-primary-emphasis"> Empty eLabFTW Preview</h1>

              </section>

              <section class="section content bg-light rounded p-3 mb-4" id="expContent">
                <!-- HTML content will be injected here -->
                <h5>No eLabFTW available. Use <a href="#home" data-bs-dismiss="offcanvas" aria-label="Close">home tab</a>
                  to start a conversion</h5>
              </section>

            </div>

            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
              <button class="btn btn-success my-3" data-bs-dismiss="offcanvas" aria-label="Close">Save </button>

              <!-- Conversion Section -->
              <section class="section conversion rounded p-3 mb-4">
                <h3>Conversion</h3>
                <ul id="elabHeadLine"></ul>
              </section>

              <!-- Metadata Section -->
              <section class="section metadata rounded p-3 mb-4">
                <h3>Metadata</h3>
                <ul id="metadataList"></ul>
              </section>

              <!-- Related Items Section -->
              <section class="section related rounded p-3 mb-4">
                <h3>Linked Resources and Experiments</h3>
                <ul id="relatedItems"></ul>
                <ul id="relatedExps"></ul>
              </section>

              <!-- Uploads / Gallery Section -->
              <section class="section uploads rounded p-3 mb-4">
                <h3>Attachments</h3>
                <div class="gallery row g-2" id="uploadGallery">
                  <!-- Gallery items will be injected as .col-sm-6 or .col-md-4 dynamically -->
                </div>
              </section>

            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="statusModalLabel">Conversion Status</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" id="conversionTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current-conversion" type="button" role="tab" aria-controls="current-conversion" aria-selected="true">
                  Current Conversion
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-conversion" type="button" role="tab" aria-controls="history-conversion" aria-selected="false">
                  History (Last 5)
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="conversionTabsContent">
              <!-- Current Conversion Tab -->
              <div class="tab-pane fade show active" id="current-conversion" role="tabpanel" aria-labelledby="current-tab">
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbarModal" role="progressbar"
                    aria-label="Animated striped example" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"
                    style="width: 1%">
                  </div>
                </div>
                <div class="accordion" id="accordionUI">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="statusHeading">
                      <button class="accordion-button" id="pbarLabel" type="button" data-bs-toggle="collapse"
                        data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus">
                        Conversion Status

                      </button>

                    </h2>
                    <div id="submitStatus" class="accordion-collapse collapse show" aria-labelledby="statusHeading"
                      data-bs-parent="#accordionUI">
                      <div class="accordion-body" id="detailedStatus" style="max-height: 300px; overflow-y: auto;">

                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="llmStreamHeading">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#llmStreamInfo" aria-expanded="false" aria-controls="llmStreamInfo">
                        LLM Response Stream (Debug)
                      </button>
                    </h2>
                    <div id="llmStreamInfo" class="accordion-collapse collapse" aria-labelledby="llmStreamHeading"
                      data-bs-parent="#accordionUI">
                      <div class="accordion-body">
                        <div style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap;" id="llmStreamContent">
                          <!-- LLM responses will be displayed here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="elabHeading">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" id="filesAcc"
                        data-bs-target="#elabInfo" aria-expanded="false" aria-controls="elabInfo">
                        Files Changed in ARC

                      </button>

                    </h2>
                    <div id="elabInfo" class="accordion-collapse collapse" aria-labelledby="elabHeading"
                      data-bs-parent="#accordionUI">
                      <div class="accordion-body">
                        <div class="center" id="filesChanged">

                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="metadataHeading">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#conversionMetadata" aria-expanded="false" aria-controls="conversionMetadata">
                        Conversion Metadata (Troubleshooting)
                      </button>
                    </h2>
                    <div id="conversionMetadata" class="accordion-collapse collapse" aria-labelledby="metadataHeading"
                      data-bs-parent="#accordionUI">
                      <div class="accordion-body">
                        <div class="alert alert-info" role="alert">
                          <strong>Conversion Metadata:</strong> Detailed information about LLM prompts, models, timing, and results for troubleshooting.
                        </div>
                        <div id="metadataContent" style="max-height: 500px; overflow-y: auto;">
                          <p class="text-muted">No conversion metadata available yet. Metadata is saved after each conversion when LLM is enabled.</p>
                        </div>
                        <div class="mt-3" id="metadataActions" style="display: none;">
                          <button type="button" class="btn btn-sm btn-outline-primary" id="downloadMetadataBtn">
                            Download Metadata JSON
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-secondary" id="viewTroubleshootingReportBtn">
                            View Troubleshooting Report
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- History Tab -->
              <div class="tab-pane fade" id="history-conversion" role="tabpanel" aria-labelledby="history-tab">
                <div id="conversionHistoryContainer">
                  <p class="text-muted text-center py-4">No conversion history yet. Your last 5 conversions will appear here.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary d-none" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary d-none">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Prompt Editor Modal -->
    <div class="modal fade" id="promptEditorModal" tabindex="-1" aria-labelledby="promptEditorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-light border-bottom">
            <h1 class="modal-title fs-5" id="promptEditorModalLabel">AI Prompt Editor</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Alert for user guidance (shown only on first visit) -->
            <div class="alert alert-light border-start border-info border-3" role="alert" id="promptEditorWelcome" style="display: none; padding: 0.5rem 1rem;">
              <strong>Welcome to the AI Prompt Editor!</strong> Here you can customize the LLM prompt used for protocol analysis.
              Changes are saved locally and will be used for future conversions. Click <strong>Reset to Default</strong> to restore the original prompt.
            </div>

            <!-- Tabbed Interface -->
            <ul class="nav nav-tabs nav-tabs-sm" id="promptEditorTabs" role="tablist" style="margin-bottom: 0.75rem;">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="systemRole-tab" data-bs-toggle="tab" data-bs-target="#systemRole" type="button" role="tab" aria-controls="systemRole" aria-selected="true">
                  System Role
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="jsonSchema-tab" data-bs-toggle="tab" data-bs-target="#jsonSchema" type="button" role="tab" aria-controls="jsonSchema" aria-selected="false">
                  JSON Schema
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="extractionRules-tab" data-bs-toggle="tab" data-bs-target="#extractionRules" type="button" role="tab" aria-controls="extractionRules" aria-selected="false">
                  Extraction Rules
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="examples-tab" data-bs-toggle="tab" data-bs-target="#examples" type="button" role="tab" aria-controls="examples" aria-selected="false">
                  Examples
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="fullPrompt-tab" data-bs-toggle="tab" data-bs-target="#fullPrompt" type="button" role="tab" aria-controls="fullPrompt" aria-selected="false">
                  Full Prompt Preview
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="versionHistory-tab" data-bs-toggle="tab" data-bs-target="#versionHistory" type="button" role="tab" aria-controls="versionHistory" aria-selected="false">
                  Version History
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="promptEditorTabContent">
              <!-- System Role Tab -->
              <div class="tab-pane fade show active" id="systemRole" role="tabpanel" aria-labelledby="systemRole-tab">
                <div class="text-muted small mb-2" style="padding: 0.25rem 0;">
                  <strong>System Role:</strong> This defines the AI's role and sets the context for analysis. Be clear and specific.
                </div>
                <label for="systemRoleInput" class="form-label small mb-1">System Role and Context</label>
                <textarea class="form-control form-control-sm font-monospace" id="systemRoleInput" rows="6" placeholder="You are a scientific data extraction assistant..."></textarea>
              </div>

              <!-- JSON Schema Tab -->
              <div class="tab-pane fade" id="jsonSchema" role="tabpanel" aria-labelledby="jsonSchema-tab">
                <div class="text-muted small mb-2" style="padding: 0.25rem 0;">
                  <strong>JSON Schema:</strong> This defines the expected structure of the JSON output. Only modify if you understand ISA-Tab format.
                </div>
                <label for="jsonSchemaInput" class="form-label small mb-1">Expected JSON Output Structure</label>
                <textarea class="form-control form-control-sm font-monospace" id="jsonSchemaInput" rows="20" placeholder='{"samples": [...], "protocols": [...]}'></textarea>
              </div>

              <!-- Extraction Rules Tab -->
              <div class="tab-pane fade" id="extractionRules" role="tabpanel" aria-labelledby="extractionRules-tab">
                <div class="text-muted small mb-2" style="padding: 0.25rem 0;">
                  <strong>Extraction Rules:</strong> These are critical instructions for parameter extraction, sample handling, protocol linking, and data file mapping.
                </div>
                <label for="extractionRulesInput" class="form-label small mb-1">Extraction Rules</label>
                <textarea class="form-control form-control-sm font-monospace" id="extractionRulesInput" rows="20" placeholder="CRITICAL - PARAMETER EXTRACTION RULES: ..."></textarea>
              </div>

              <!-- Examples Tab -->
              <div class="tab-pane fade" id="examples" role="tabpanel" aria-labelledby="examples-tab">
                <div class="text-muted small mb-2" style="padding: 0.25rem 0;">
                  <strong>Examples:</strong> Provide concrete examples to guide the AI's output format. Good examples improve extraction accuracy.
                </div>
                <label for="examplesInput" class="form-label small mb-1">Examples of Good Extraction</label>
                <textarea class="form-control form-control-sm font-monospace" id="examplesInput" rows="20" placeholder="EXAMPLES: **Good parameter extraction**..."></textarea>
              </div>

              <!-- Full Prompt Preview Tab -->
              <div class="tab-pane fade" id="fullPrompt" role="tabpanel" aria-labelledby="fullPrompt-tab">
                <div class="text-muted small mb-2" style="padding: 0.25rem 0;">
                  <strong>Read-Only Preview:</strong> This shows how your sections combine into the final prompt sent to the AI.
                </div>
                <label for="fullPromptPreview" class="form-label small mb-1">Assembled Prompt (Read-Only)</label>
                <textarea class="form-control form-control-sm font-monospace bg-light" id="fullPromptPreview" rows="25" readonly></textarea>
              </div>

              <!-- Version History Tab -->
              <div class="tab-pane fade" id="versionHistory" role="tabpanel" aria-labelledby="versionHistory-tab">
                <div class="alert alert-light border-start border-info border-3" role="alert" id="versionHistoryWelcome" style="display: none; padding: 0.5rem 1rem; margin-bottom: 0.75rem;">
                  <strong>Version History:</strong> Your last 50 prompt versions are saved automatically. Compare, restore, export, or import previous versions.
                </div>

                <!-- Controls Toolbar -->
                <div class="d-flex gap-2 align-items-center flex-wrap mb-2">
                  <input type="text" class="form-control form-control-sm" id="versionSearchInput" placeholder="Search versions..." style="max-width: 250px;">
                  <span class="text-muted small" id="versionCountDisplay"></span>
                  <div class="ms-auto d-flex gap-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="exportAllVersionsBtn" title="Export all versions">
                      Export All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="importSingleVersionBtn" title="Import single version">
                      Import Single
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="importAllVersionsBtn" title="Import all versions">
                      Import All
                    </button>
                  </div>
                </div>

                <!-- Version List -->
                <div class="list-group list-group-flush" id="promptVersionList" style="max-height: 450px; overflow-y: auto;">
                  <!-- Version items will be dynamically inserted here -->
                </div>

                <!-- Hidden file inputs for import -->
                <input type="file" id="importSingleFileInput" accept=".json" style="display: none;">
                <input type="file" id="importAllFileInput" accept=".json" style="display: none;">

                <!-- Diff Viewer -->
                <div class="row mt-4" id="diffViewerSection" style="display: none;">
                  <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6>Version Comparison</h6>
                      <button type="button" class="btn btn-sm btn-secondary" id="closeDiffBtn">Close Diff</button>
                    </div>
                    <div id="diffOutputContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                      <!-- Diff2html output will be rendered here -->
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div class="text-center text-muted mt-4" id="emptyVersionState" style="display: none;">
                  <p>No version history available yet.</p>
                  <p><small>Versions are saved automatically when you click "Save Prompt".</small></p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light border-top py-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetPromptBtn">
              Reset to Default
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-secondary btn-sm" id="savePromptBtn">
              Save Prompt
            </button>
            <button type="button" class="btn btn-dark btn-sm" id="saveAndConvertBtn">
              Save &amp; Start Conversion
            </button>
          </div>
        </div>
      </div>
    </div>


  </main>

  <!-- JavaScript - Load at end of body for DOM availability -->
  <script src="./js/bootstrap.bundle.min.js"></script>
  <script src="./js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/git.js"></script>
  <script src="./js/main-25-07-15.js" type="text/javascript"></script>
  <script src="./js/turndown.js" type="text/javascript"></script>
  <script src="./js/exceljs.min.js"></script>

  <!-- Diff libraries for version comparison -->
  <script src="https://cdn.jsdelivr.net/npm/diff/dist/diff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>

  <!-- Module import -->
  <script type="module">
    import http from './js/http.js'
    window.http = http;
  </script>

  <!-- Application code (order matters - load after DOM and libraries) -->
  <script src="./js/MEMfsGUI1006.js?v=20251008101314" type="text/javascript" charset="utf-8"></script>

  <!-- Load modular components before core -->
  <script src="./js/modules/conversion-metadata.js?v=20251021100100" type="text/javascript" charset="utf-8"></script>
  <script src="./js/modules/isa-generation.js?v=20251008120855" type="text/javascript" charset="utf-8"></script>
  <script src="./js/modules/llm-service.js?v=20251021141000" type="text/javascript" charset="utf-8"></script>
  <script src="./js/modules/extra-fields-handler.js?v=20251029000000" type="text/javascript" charset="utf-8"></script>

  <!-- Main application core -->
  <script src="./js/elab2arc-core1107.js?v=20251107170000" type="text/javascript" charset="utf-8"></script>

  <!-- Toast Notification Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 9999;">
    <!-- Toasts will be dynamically added here -->
  </div>

</body>

</html>