<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="elab2ARC, convert eLabFTW experiments to ARCs">
  <meta name="keywords" content="elab2ARC">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" type="image/x-icon" href="favicon.png">
  <style>
    

  </style>  
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <script src="./js/bootstrap.bundle.min.js"></script>
  <link href="./css/custom2607.css" rel="stylesheet" />
  <link href="./css/bs5-intro-tour.css" rel="stylesheet" />
  <link href="./css/MEMfsGUI.css" rel="stylesheet" />
  <link href="./css/elabGUI.css" rel="stylesheet" />
  <script src="./js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/MEMfsGUI.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/elabGUI.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/git.js"></script>
  <script src="./js/main-25-01-21.js" type="text/javascript"></script>
  <script src="./js/turndown.js" type="text/javascript"></script>
  <script type="module">
    import http from './js/http.js'
    window.http = http;
    // window.fs = new LightningFS('fs')
    // window.pfs = window.fs.promises
  </script>


</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>
    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group  g-0 d-md-block dropdown col-auto">
        
        <button type="button" onclick="location.href=location.href.split('#')[0]+'#elab'" class="btn d-none  btn-nav"
        id="submitNavBtn">
        Fetch eLabFTW &nbsp;
        </button>
      
        <button class="btn btn-nav dropdown-toggle" id="instance" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          eLabFTW Instance: HHU
        </button>
        <ul class="dropdown-menu">
          <li><button class="dropdown-item" onclick="setelabURL('https://elab.dataplan.top/api/v2/')" type="button">eLabFTW Instance: DataPLANT</button></li>
          <li><button class="dropdown-item d-none" onclick="setelabURL('https://demo.elabftw.net/api/v2/')" type="button">eLabFTW Instance: Demo</button></li>
          <li><button class="dropdown-item" onclick="setelabURL('https://elabftw.hhu.de/api/v2/')" type="button">eLabFTW Instance: HHU</button></li>
          <li>&nbsp;&nbsp;&nbsp;Add&nbsp;instance:&nbsp;<input type="text" id="customElab" onchange="setelabURL(this.value)" placeholder=" https://elabftw/api/v2/"><br>&nbsp;&nbsp;&nbsp;For&nbsp;example:&nbsp;"https://elabftw.test.hhu.de/api/v2" </li>
        </ul>
      

        <button type="button" onclick="location.href=location.href.split('#')[0]+'#elab'" class="btn  btn-nav"
        id="elab2arcNavBtn">
        elab2ARC (1-click)&nbsp;
        </button>
        
        <button type="button" onclick="location.href=location.origin+'/elab2arc/#ftw'" class="btn btn-nav "
          id="ftwBtn">
        ElabFTW&nbsp;
        </button>
        
        <button type="button" onclick="location.href=location.origin+'/elab2arc/#arc'" class="btn btn-nav "
          id="arcBtn">
        ARCs&nbsp;
        </button>

       

        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converterlong" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlinklong" class="dropdown-item" target="_blank" href="https://github.com/nfdi4plants/elab2arc">GitHub</a>
          </li>
          <li>
            <a id="aboutlong" class="dropdown-item d-none" href=''>About</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container">
    <div name="tab" class=" col-12 justify-content-center d-none nav-link text-center" id="introTab">
      <a href="#elab">
        <h1>Fetch eLabFTW experiments </h1>
      </a>
     
     
    </div>

    <div name="tab" class="row justify-content-center" id="elabTab">
      <h1 class="center"> eLabFTW to ARC </h1>


      <form id="authForm"  action="/elab2arc/#elab" >
        <div class="row justify-content-center align-items-end">
        <div class="m-3 col-lg-3">
          <label for="elabexperimentid" class="form-label">
            <button class="btn text-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#experimentIdCanvas" aria-controls="experimentIdCanvas">
              eLabFTW Experiment ID &#128712;</button>
            (use comma "," to seperate multiple IDs)</label>
          <textarea type="text"  name="elabid" class="form-control" autocomplete="username"  id="elabexperimentid" aria-describedby="elabexpHelp" required></textarea>
          <div id="elabexpHelp" class="form-text d-none">Experiment ID can be found in the address bar of the browser.
          </div>
        </div>
        <div class="m-3 col-lg-2 ">
          <label for="elabToken" class="form-label">
           
            <button class="btn text-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#elabTokenCanvas" aria-controls="elabTokenCanvas">
              eLabFTW  API Key&nbsp;&#128712;</button>
          </label>
          <input type="text" name="elabtoken" class="form-control" autocomplete="password"  id="elabToken" required>
        </div>

        <div class="m-3 col-lg-2">
          <label for="datahubToken" class="form-label">
            <button class="btn text-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#datahubTokenCanvas" aria-controls="datahubTokenCanvas">
              DataHub   Access Token&nbsp;&#128712;</button>
            
          </label>
          <input type="text" name="datahubtoken" class="form-control" autocomplete="password"  id="datahubToken" required>
        </div>

        <div class="m-3 col-lg-2 d-none">
          <label for="elabURLInput" class="form-label">elabURL</label>
          <input type="text" name="elabURL" value="https://elabftw.hhu.de/api/v2/" class="form-control" autocomplete="password"  id="elabURLInput" required>
        </div>

        <div class="mb-3 col-lg-2 ">
          <label for="elabsubmit" class="form-label">Submit Options</label><br>
         
            
            <button class="btn btn-primary"  type="submit" data-bs-toggle="collapse" data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus" > One Click Submission </button>
            <br>
            <button  class="btn btn-primary" type="button" onclick="startStepByStep()" ><span> Step by Step </span></button>
            <button type="button" class="btn btn-secondary" id="statusModalBtn" data-bs-toggle="modal" data-bs-target="#statusModal">
              Check Status
            </button>
            
            <div id="toolstatus"  class="col-10 m-auto">
            <!-- <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-title="Under Construction"> -->
             
             
            
          <!-- </span> -->

         
                   
        </div>
      </div>
      </form>
     
       
        
      </div>
      <div class="row justify-content-center m-3">
        <img id="bbb"></img>
      </div>
      
    </div>
    
    <div name="tab" class=" col-12 d-none" id="arcTab">
      <div class="input-group mb-3">
        <input type="text" class="form-control" id="usernameInput" placeholder="Username" aria-label="Username">
        <span class="input-group-text">/</span>
        <input type="text" class="form-control" id="projectnameInput"  placeholder="Project Name" aria-label="Projectname">
        <span class="input-group-text">Description:</span>
        <input type="text" class="form-control" id="descriptionInput"  placeholder="Project Name" aria-label="Projectname">
        <button class="btn btn-primary" onclick="createNewArc()"> Create a new ARC </button>
      </div>
      
      <div class="" style="height: 50vh; overflow-y: scroll">

        <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
          <thead>
            <tr>
              <th scope="col">Number</th>
              <th scope="col">User/Group</th>
              <th scope="col">Repo Name</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="userProjectsTable">
          </tbody>
        </table>
      </div>
      
      <div class="row m-3">
        <div class="col-12">
          <div id="fs-container">
            <div id="fileTree"></div>
        </div>
        <div class="text-center m-3" >
          <span class="" id="elabFTWInfo"> Main ElabFTW Protocol Used  </span> <span class=" text-success" id=""> ====>>>  </span>
          <span class="" id="gitlabInfo"> GitLab URL </span> 
          <span class="" id="arcInfo"> Please select your ARC </span> <button type="button" class="btn btn-primary" onclick="singleConvert()">Start Convert</button>
          <button type="button" class="btn btn-secondary" id="statusModalBtn" data-bs-toggle="modal" data-bs-target="#statusModal">
            Check Status
          </button>
          </div>
       
          <!-- <h4> Imported ARCs </h4>
          <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
            <thead>
              <tr>
                <th scope="col">ARC Name</th>
                <th scope="col">Import Time</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="importedARCTable">
            </tbody>
          </table> -->
        </div>
        <div class="col-7">

         
        </div>
      </div>
     


    </div>
    <div name="tab" class=" col-12 d-none align-items-center m-auto" id="ftwTab">
   
      <div class="elab-container mt-3">
        <div class="main-content">
            <div class="section title">
                <h1 id="expTitle">Loading...</h1>
            </div>
            <div class="section content" id="expContent">
                <!-- HTML content will be injected here -->
            </div>
        </div>
        <div class="sidebar ">
            <div class="section metadata" id="expMetadata">
                <h3>Metadata</h3>
                <ul id="metadataList"></ul>
            </div>
            <div class="section related" id="expRelatedItems">
                <h3>Related</h3>
                <div id="relatedItems"></div>
                <div id="relatedExps"></div>
            </div>
            <div class="section uploads" id="expUploads">
              <h3>Attachments</h3>
              <div class="gallery" id="uploadGallery"></div>
          </div>
        </div>
    </div>
    </div>
    
    
    
    
    <div name="tab" class=" col-8 d-none align-items-center m-auto" id="updateTab">

      <div class=" area uploadarea my-3" id="importArea" ondragenter="this.className='area uploadarea dragging'"
        ondrop=";DragAndDrop(event)" style=" width:100%">


        <input type="file" id="import" multiple>
      </div>
      <div class="text-center m-auto">
        <button class="text btn btn-primary d-none" id="toSubmit" onclick="location.href=location.href.split('#')[0]+'#submit'" > 
          Start Submission
        </button>
      </div>
      <div id="alertPlace"> </div>
      
      
    </div>
  </div>
  <button type="button" class="btn btn-primary d-none" id="loadingModalBtn" data-bs-toggle="modal"
    data-bs-target="#loadingModal">
    Launch loading modal
  </button>
  <div class="modal" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="#loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="loadingModalLabel">Processing</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>


          </div>
         

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        </div>
      </div>
    </div>
  </div>


  <!-- Button trigger modal -->
<button type="button" class="btn btn-primary d-none" id="statusModalBtn" data-bs-toggle="modal" data-bs-target="#statusModal">
  Launch Status modal
</button>

<!-- Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="statusModalLabel">Conversion Status</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbarModal" role="progressbar"
            aria-label="Animated striped example" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"
            style="width: 1%">
          </div>
        </div>
        <div class="accordion" id="accordionUI">
          <div class="accordion-item">
            <h2 class="accordion-header" id="statusHeading">
              <button class="accordion-button" id="pbarLabel" type="button" data-bs-toggle="collapse" data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus">
                Conversion Status

              </button>

            </h2>
            <div id="submitStatus" class="accordion-collapse collapse" aria-labelledby="statusHeading" data-bs-parent="#accordionUI">
              <div class="accordion-body" id="detailedStatus">

              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="elabHeading">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" id="filesAcc" data-bs-target="#elabInfo" aria-expanded="true" aria-controls="elabInfo">
                Files Changed in ARC 

              </button>
             
            </h2>
            <div id="elabInfo" class="accordion-collapse collapse" aria-labelledby="elabHeading" data-bs-parent="#accordionUI">
              <div class="accordion-body">
                <div class="center" id="filesChanged">
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary d-none" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary d-none">Save changes</button>
      </div>
    </div>
  </div>
</div>
  <script type="text/javascript">
    var fs = FS.fs;
    var elabJSON;
    var statusInfo;
    const version = "2024-12-09";
    var blobb = [];
    
    const detailedInfo = document.getElementById("detailedStatus");
    const filesChanged =document.getElementById("filesChanged");
    
    var turndownService = new TurndownService();
    var mainOrMaster = "main";
    turndownService.keep(['table']);
    function connectionTest(url){

    }

    function proxySwitch(){
    }

    const startStepByStep= async ()=>{
      loading.show();
      const datahubToken = document.getElementById("datahubToken").value;
      const elabToken = document.getElementById("elabToken").value;
      const elabURL = document.getElementById("elabURLInput").value;
      const elabid = document.getElementById("elabexperimentid").value;
      setCookies( elabid, elabToken, datahubToken);
      const id = await fetchUser(datahubToken);
      if (id){
      document.getElementById("usernameInput").value = id.username;
      await fetchUserProjects(id.username, datahubToken) 
      loading.hide();
    }
      else{
        return;
      }
      loadExperiment(elabURL);
      document.getElementById("ftwBtn").click();

    }

    const fetchUser = async (accessToken ) => {
      try {
        // Define the API endpoint for fetching user-related projects
        const apiUrl = `https://corsproxy.cplantbox.com/https://git.nfdi4plants.org/api/v4/user`;

        // Fetch the data from the API with the access token in the headers
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}` // Include the token in the Authorization header [[3]]
          }
        });
        console.log(response);
        // Check for bad responses (status codes between 400 and 599)
        if (response.status == 401){
          loading.hide();
          throw new Error(" Unauthorized, the DataHUB token is wrong or expired. Or a project-token has been used for step by step conversion. Please use a personal-token with correct rights ");
        }else if(response.status >= 400 && response.status < 500){
          throw new Error(" Unauthorized, the DataHUB token is wrong or expired. Or a project-token has been used for step by step conversion. Please use a personal-token with correct rights  ");
        }else if (response.status >= 500 && response.status < 600) {
          throw new Error("Bad response from server, please check the availability of the server. ");
        }

        // Parse the JSON response
        const userJSON = await response.json();

        // Assign the fetched data to a global variable (if needed)
        window.userId = userJSON;

        // Build the HTML table dynamically
       return userJSON;
      } catch (error) {
        // Handle any errors that occur during the fetch or processing
        alert(error.message || error);
      }
    };

    const   createNewArc  = async ()=>{
      const projectDescription = document.getElementById("descriptionInput").value;
      const projectName = document.getElementById("projectnameInput").value;
      const username = document.getElementById("usernameInput").value;
      
          const accessToken = document.getElementById("datahubToken").value;
          await  createGitLabRepo(projectName, projectDescription, accessToken);
          const url = `https://git.nfdi4plants.org/${username}/${projectName}.git`;
          await  cloneARC(url, projectName );
          newARC = new arctrl.ARC();
          await  arcWrite(projectName, newARC);
          await git.add({ fs, dir: projectName, filepath: '.' });
          await commitPush(accessToken,url,"elab2arcTool","", projectName);
          
        }


    const createGitLabRepo = async (projectName, projectDescription, accessToken) => {
          try {
              // Define the API endpoint for creating a new project [[4]][[6]]
              const apiUrl = `https://corsproxy.cplantbox.com/https://git.nfdi4plants.org/api/v4/projects`;

              // Prepare request configuration
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`, // Authentication header [[3]]
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      name: projectName,
                      description: projectDescription,
                      visibility: 'private', // Optional: Set default visibility [[7]]
                      initialize_with_readme: 'true',
                      default_branch:'main',
                      lfs_enabled: 'true',


                  })
              });

              // Handle non-success responses [[3]]
              if (response.status >= 400) {
                  const errorDetails = await response.json();
                  throw new Error(`Error ${response.status}: ${errorDetails.message}`);
              }

              // Return the created project details [[6]]
              return await response.json();

          } catch (error) {
              // Handle network/API errors [[6]]
              alert(" ARC creation failed, please check if the name is unique"+error.message || error);
              throw new Error(`Project creation failed: ${error.message}`);
          }
      };

    const fetchUserProjects = async (userId, accessToken) => {
      try {
        // Define the API endpoint for fetching user-related projects
        const apiUrl = `https://corsproxy.cplantbox.com/https://git.nfdi4plants.org/api/v4/users/${userId}/projects`;

        // Fetch the data from the API with the access token in the headers
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}` // Include the token in the Authorization header [[3]]
          }
        });

        // Check for bad responses (status codes between 400 and 599)
        if (response.status >= 400 && response.status < 600) {
          throw new Error("Bad response from server, please check the availability of the server");
        }

        // Parse the JSON response
        const projects = await response.json();

        // Assign the fetched data to a global variable (if needed)
        window.userProjects = projects;

        // Build the HTML table dynamically
        let tableHTML = '';
        let newIndex = 0;

        projects.forEach((project) => {
          if (project.name) { // Ensure the project has a valid name
            newIndex += 1;

            tableHTML += `
              <tr>
                <th scope="row">${newIndex}</th>
                <td>${project.name}</td>
                <td><a href="${project.web_url}" target="_blank">View Project</a></td>
                <td>
                  <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" onclick=" cloneARC('${project.http_url_to_repo}', '${project.name}')" class="btn btn-primary ">
                      Convert to this ARC
                    </button>
                    <button type="button" onclick="cloneARC('${ project.http_url_to_repo}', '${project.name}')" class="btn btn-secondary d-none">
                      Clone Only
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }
        });

        // Insert the generated table HTML into the DOM
        document.getElementById("userProjectsTable").innerHTML = tableHTML;
      } catch (error) {
        // Handle any errors that occur during the fetch or processing
        alert(error.message || error);
      }
    };


    
    function setelabURL(elabURL){
      var elabURL1 = unescape(elabURL);
      elabURL1.slice(-1)=="/"? {} : elabURL1= elabURL1 +"/"  ;
      try {
        const split =  elabURL1.split("/api");
        split.length ==1?  elabURL1= elabURL1 +"api/v2/": {}  ;
      } catch (error) {
        
      }
      window.localStorage.setItem('elabURL',elabURL1); 
      document.getElementById('elabURLInput').value=elabURL1 ;
      document.getElementById('instance').innerHTML = 'instance: '+elabURL1; 
      document.getElementById('elabURLInput').value = elabURL1;
    }
    async function fetchElabJSON( elabToken, query='experiments/',  elabURL , corsproxy ='https://corsproxy.cplantbox.com/'){
      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;
      // Define the API key      
      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'x-requested-with'};
      // Make the fetch request      
      try {
       const response = await fetch(elabftwServerUrl, { headers, method: 'GET'});
       const json = await response.json();
       return json;
      } catch (error) {
        if (error.message.includes(`is not valid JSON`)||error.message.includes(`Invalid host`) || error.message.includes(`!DOCTYPE`)){
          showError("Access of eLabFTW is not successful, the eLabFTW API key might be wrong, or the elabFTW instance might be wrong. Please first check the eLabFTW instance and then go to the settings of the eLabFTW to create a new API key and use it");
        }else{
          showError("Access of eLabFTW is not successful, error message is "+ error);
        }
        return error;
      }
    }

    async function fetchElabFiles( elabToken, query='experiments/',  elabURL, corsproxy ='https://corsproxy.cplantbox.com/' ){
      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;
      // Define the API key
      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'x-requested-with'};
      // Make the fetch request
      try {
      var response = await fetch(`${elabftwServerUrl}`, { headers, method: 'GET'});
      return response.blob();
      } catch (error) {
        if (error.message.includes(`Unexpected token 'N', "No corresp"... is not valid JSON`)){
          console.error(error);
          showError("Access of eLabFTW is not successful, the eLabFTW API key might be wrong, please go to settings to create a new API key and use it");
        }else{
          showError("Access of eLabFTW is not successful, error message is "+ error);
        }
        
        return error;
      }
      }
    
    function gitUrlCheck(url){
      if (/(?:git|ssh|https?|git@[-\w.]+):(\/\/)?(.*?)(\.git)(\/?|\#[-\d\w._]+?)$/.test(url)){
        updateInfo("DataHub URL was collected successfully" ,"30");
        return url;
      }
      else{
        //updateInfo("DataHub URL is not correct, automatic patches are done " ,"30");
        if (!url.endsWith(".git")){
        url = url + ".git";
        //updateInfo("Added \" .git\" at the end, current url is "+ url ,"30");
      }
      if (!url.startsWith("https://")){
        url = "https://" + url ;
        updateInfo("Added \" https:// \" at the start, current url is "+ url ,"30");
      }
      return url;
      }
      
    }
    
    async function datahubClone(datahubURL, dir, datahubtoken){
      const [begin, end] = datahubURL.split("//");
      url = begin + "//oath2:" + datahubtoken + "@" + end;
          console.log(url);
      try {
        const cloneResponse = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://gitcors.cplantbox.com',
          url: url,
          ref: 'main',
          singleBranch:true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(10 + (event.loaded / event.total)*30)
            } else {
              updateIndeterminateProgressBar(10 + (event.loaded / 100)*30)
            }
          }
        });
        mainOrMaster = "main";
      } catch (error) {
        console.error(error);
        updateInfo("Clone branch main failed, now try to clone branch master", "50")
        const cloneResponse = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://gitcors.cplantbox.com',
          url: url,
          ref: 'master',
          singleBranch:true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(50 + (event.loaded / event.total)*30)
            } else {
              updateIndeterminateProgressBar(50 + (event.loaded / 100)*30)
            }
          }
        });
        mainOrMaster = "master";
      }
      
    }

    async function commitPush( datahubtoken, datahubURL, fullname, email, dir, gitRoot ){
      let sha = await git.commit({
          fs,
          dir: gitRoot,
          author: {
            name: fullname,
            email: email,
          },
          message: "eLabFTW2ARC version "+ version +".  "+ statusInfo
        });
        console.log("commit finished");
        try {
          let pushResult = await git.push({
          fs,
          http,
          dir: gitRoot,
          remote: 'origin',
          force: true,
          ref: 'main',
          onAuth: () => ({ username: datahubtoken }),
        });
        console.log(pushResult)  ;
        updateInfo("PLANTDataHUB has been updated.  <br>", "100");
        //
        } catch (error) {
          console.error(error);
          updateInfo( error+" Push to main failed, now try to push to branch master", "0");
          let pushResult = await git.push({
          fs,
          http,
          dir: dir,
          force: true,
          remote: 'origin',
          ref: 'master',
          onAuth: () => ({ username: datahubtoken }),
        });
        console.log(pushResult)  ;
        showError( datahubURL +"ARC has been updated on master branch");
          //showError( "push to git failed. The error is "+ error)
        }
    }
    
    async function createAssay(assayId, dir){
      try {
        fs.statSync(dir+"/assays/"+assayId+"/protocols");
      } catch (error) {
        console.error(error);
        fs.mkdirSync(dir+"/assays/"+assayId+"/protocols",{ recursive: true } )
      };
      try {
        
        fs.statSync(dir+"/assays/"+assayId+"/dataset");
      } catch (error) {
        console.error(error);
        fs.mkdirSync(dir+"/assays/"+assayId+"/dataset",{ recursive: true } )
      } 
      
    }

    function setCookies(elabid, elabtoken, datahubtoken, instance="https://elabftw.hhu.de/api/v2/"){
      const maxAge = 60*60*24*31;
          document.cookie = `elabid=${encodeURIComponent(elabid)}; SameSite=lax; max-age=${maxAge}; Secure`;
          document.cookie = `elabtoken=${encodeURIComponent(elabtoken)}; SameSite=lax; max-age=${maxAge}; Secure`;
          document.cookie = `datahubtoken=${encodeURIComponent(datahubtoken)}; SameSite=lax; max-age=${maxAge}; Secure`;
          window.localStorage.setItem(instance, instance); 
    }

    function updateInfo(text, percent){
      updateLabel(text);
      updateProgressBar(percent);
      const event = new Date();
      statusInfo += event.toLocaleString('en-GB', { timeZone: 'UTC' }) +"&nbsp; &nbsp; &nbsp;" + text +"\t " + "<br>";
      detailedInfo.innerHTML = statusInfo;       
    }


    const singleConvert = async ()=>{
      const gitlabusername = document.getElementById("usernameInput").value;
      const gitlabURL = document.getElementById("gitlabInfo").innerHTML;
      // if (gitlabURL.includes("Please select your")){
      //   alert("No ElabFTW is selected, please go to ElabFTW tab to select.");
      //   return;
      // };
      const arcName = document.getElementById("arcInfo").innerHTML;
      if (arcName.includes("Please select your ARC")){
        alert("please select your ARC.");
        return;
      };
      const elabtoken = document.getElementById("elabToken").value;
      const datahubtoken = document.getElementById("datahubToken").value;
      const instance = document.getElementById("elabURLInput").value;
      const users = await fetchElabJSON(elabtoken, "users",  instance); 
      const params = await getParameters(1, elabtoken, datahubtoken,instance);
      const elabid = document.getElementById("elabexperimentid").value;
      elabidList = elabid.split(",");
      window.elabJSON = window.elabJSON.metadata;
      await processExperiment(0, elabidList[0], params, window.elabJSON, users, gitlabURL, arcName );
      refreshTree(arcName);
    }
    // async function updateAll2(elabid, elabtoken, datahubtoken, instance="https://elabftw.hhu.de/api/v2/"){
    //   try {   
    //   filesChanged.innerHTML="";
    //   statusInfo = "";
    //   elabid = elabid || document.getElementById("elabexperimentid").value;
      
    //   elabtoken = elabtoken || document.getElementById("elabToken").value;
    //   datahubtoken = datahubtoken || document.getElementById("datahubToken").value;
    //   setelabURL(instance);
    //   instance = unescape(instance);
    //   setCookies( elabid, elabtoken, datahubtoken);
      
    //   elabid = decodeURIComponent(elabid);
    //   elabidList = elabid.split(",");
    //   totalExp = elabidList.length
    //   for (const [expIndex, elabid] of Object.entries(elabidList) ){
    //     if (elabid){
    //       const ratio = (expIndex+1)/totalExp;
    //       updateInfo("Fetching eLabFTW experiment <b> "+ elabid +"</b>, instance is "+instance, ratio* 10);
    //       res = await fetchElabJSON(elabtoken, "experiments/"+elabid,  instance);
    //       window.elabJSON = res;
    //       const users = await fetchElabJSON(elabtoken, "users", instance);
    //       const extra_fields = res.metadata_decoded.extra_fields;
    //       const datahubURL = gitUrlCheck(extra_fields.datahub_url.value);;
    //       // const assayId  = res.title.replaceAll(".", "-dot-").replaceAll("/", "-slash-");
    //       const assayId  = res.title.replace(/\//g, "|").replace(/[^a-zA-Z0-9_\-]/g, "_");
    //       const fullname = res.fullname;
    //       const user = users.find(e=> e.fullname == fullname)
    //       const email = user.email;
    //       let protocol = res.body;
    //       const elabWWW= instance.replace("api/v2/", "");
    //       protocol = protocol.replace(/\w+\.php\?mode=view/g, elabWWW+"/$&"  );
          
    //       console.log("protocol is" + protocol);
    //       let markdown = turndownService.turndown(protocol);
    //       updateInfo("DataHUB URL fetched from elabFTW's extra_field is \""+datahubURL, "\"" + ratio*20 );
          
      
      
    //       const dir = "arc"+elabid;
    //       await datahubClone(datahubURL, dir, datahubtoken);
    //       let ls;
    //       try {
    //         ls = fs.readdirSync(dir+"/assays")
    //       } catch (error) {
    //         ls = fs.readdirSync(dir)
    //       }
          
    //       //updateInfo("Assays are "+ ls.toString().replaceAll(",", "<br>") +". Updating assay <b>" + assayId+ "</b>", "30" );
    //       await createAssay(assayId, dir);
    //       await fullAssay2(assayId, "new metadata table", res.lastname, res.firstname, email, res.team_name, "Generated by elab2ARC tool on "+Date() , dir);
    //       updateInfo("isa.assay.xlsx has been updated at <b>"+assayId+"</b> ", ratio*35);
    //       await git.add({ fs, dir: dir, filepath: "assays/"+assayId+"/isa.assay.xlsx"})
    //       statusHTML =  
    //       `
    //       <table class="table table-striped table-hover">
    //         <thead>
    //           <tr>
                
    //             <th scope="col">eLabFTW Experiment `+elabid +`</th>
    //             <th scope="col">ARC files updated</th>
    //           </tr>   
    //       </thead>
    //         <tbody>
    //           <tr>
    //             <td id="protocolHTML">
    //             `+ protocol +`
    //             </td>
    //             <td>
    //               ARC file path is  `+ dir+`assays/`+encodeURIComponent(assayId)+`/protocols/eLabFTW_protocol.md
    //               <br>
    //               <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/assays/`+encodeURIComponent(assayId)+`/protocols/eLabFTW_protocol.md" target="_blank" >click to check the file</a>
    //             </td>  
    //           </tr>     
    //       `

    //       const uploads = res.uploads;
    //       let fileList = [];
    //       //let filedict = {};
    //       for (const [index, ele] of Object.entries(uploads)){
    //         const blobs = await fetchElabFiles( elabtoken, "experiments/"+ elabid+ "/uploads/"+ ele.id +"?format=´binary´",instance);
    //         blobb.push(blobs);
    //         let objectURL = URL.createObjectURL(blobs)
    //         objectURL= objectURL.replace( /&storage=./g , "" );        
    //         let data = new Uint8Array(await blobs.arrayBuffer());
    //         // const extension = blobs.type.split("/").slice(-1)[0];
    //         const realname =  ele.real_name.replace(/[^a-zA-Z0-9_,\-+%$|(){}\[\]*=#?&$!^°<>;]/g, "_");
    //         const longname= ele.long_name;
    //         const longname2= encodeURIComponent(ele.long_name);
            
            
    //         const path = "assays/"+assayId+"/dataset/"+index+"_"+realname;
    //         const markdownPath = "assays/"+encodeURIComponent(assayId)+"/dataset/"+index+"_"+realname;

    //         //filedict[longname] = datahubURL.slice(0,-4)+`/-/raw/main/`+path;

    //         //statusHTML = statusHTML.replaceAll( "app/download.php?f="+longname , objectURL );
    //         statusHTML = statusHTML.replace( /app\/download\.php(.*)f=/g, "" );
    //         statusHTML = statusHTML.replaceAll( longname , objectURL );
    //         statusHTML = statusHTML.replaceAll( longname2 , objectURL );
    //         statusHTML = statusHTML.replaceAll( "&amp;storage=1" , "" );
    //         statusHTML = statusHTML.replaceAll( "&amp;storage=2" , "" );
    //         markdown = markdown.replace(/app\/download\.php(.*)f=/g, "")
    //         markdown = markdown.replace(/&storage=./g, "")
    //         markdown = markdown.replaceAll( longname , datahubURL.slice(0,-4)+`/-/raw/`+mainOrMaster+`/`+markdownPath );
    //         markdown = markdown.replaceAll( longname2 , datahubURL.slice(0,-4)+`/-/raw/`+mainOrMaster+`/`+markdownPath );
    //         await fs.promises.writeFile(dir+"/"+path , data);
    //         await git.add({ fs, dir: dir, filepath: path });
            
    //         updateInfo("Added file " + realname, ratio*(10+(index/uploads.length * 10)) );
    //         if(blobs.type.includes("image") ){
    //           statusHTML +=  
    //         `
    //           <tr>
    //             <td>
    //               <img  src="`+ objectURL +`">
    //             </td>
    //             <td>
    //               Submitted
    //               ARC file path is: `+path+`.
    //               <br>
    //               <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/`+encodeURIComponent(path)+`" target="_blank" >click to check the file</a>
    //             </td>
    //           </tr>

    //         `
    //           } else {
    //             statusHTML +=  
    //         `
    //           <tr>
    //             <td>
    //               file name is `+realname+` 
    //             </tb>
    //             <td>
    //               Submitted
    //               ARC file path is: `+path+`.
    //               <br>
    //               <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/`+encodeURIComponent(path)+`" target="_blank" >click to check the file</a>
    //             </td>
    //           </tr>

    //         `
    //           }
    //         }
            
    //         await fs.promises.writeFile(dir+'/assays/'+assayId+'/protocols/eLabFTW_protocol.md' , markdown);
            
    //         await git.add({ fs, dir: dir, filepath: 'assays/'+assayId+'/protocols/eLabFTW_protocol.md' });
    //         await fs.promises.writeFile(dir+'/assays/'+assayId+'/dataset/readme.md' , "# Data files");
    //         await git.add({ fs, dir: dir, filepath: "assays/"+assayId+"/dataset/readme.md"})
    //         updateInfo("Finished adding protocol files in ARC", ratio*70 );
    //         updateInfo("All files have been added to ARC, starting to push ARC to", ratio*80 );
            
    //         await commitPush(datahubtoken, datahubURL, fullname, email, dir );
    //         //updateInfo("ARC updated Successfully<br>" , "100" );
    //         document.getElementById("filesAcc").click();
    //         statusHTML += "</tbody> </table>";
    //         statusHTML = statusHTML.replaceAll( "<img", "<img class='img-fluid'" );
    //         filesChanged.innerHTML += statusHTML;
    //       }
    //     }
    //   } catch (error) {
    //     if (error.message.includes("401")){
    //       showError( "Error: Unable to access PLANTdataHUB, error is "+ error+". Please verify that the DataHub Token matches the datahub_url in the extra_fields of eLabFTW. ");
    //       console.error(error);
    //     }else if(error.message.includes("Cannot read properties of undefined")){
    //       showError("eLabFTW accessed successfully, but extra_fields is missing. Please check the experiment ID and extra_fields in eLabFTW, error is "+ error+".");
    //     }else if(error.message.includes("403")){
    //       showError("Error: Error: PLANTdataHUB can not be acccessed. Please verify that the datahub_url in the extra_fields of eLabFTW is correct. error is "+ error+". ");
    //     }
    //      else{
    //       showError( "Error: eLabFTW to ARC conversion failed, error is "+ error);
    //       console.error(error);
    //     }
    //     updateInfo("ARC updated failed" , "0" );
    //   }      
    // }

        // Main function orchestrating the process
        async function updateAll(elabidText, elabtoken, datahubtoken, instance = "https://elabftw.hhu.de/api/v2/") {
            try {
                // Initialize UI elements and parameters
                initializeUI();
                const params = await getParameters(elabidText, elabtoken, datahubtoken, instance);

                // Process each experiment ID
                for (const [expIndex, expId] of Object.entries(params.elabidList)) {
                    if (expId) {
                        const res = await fetchElabJSON(params.elabtoken, `experiments/${expId}`, params.instance);
                        const users = await fetchElabJSON(params.elabtoken, "users", params.instance);
                        const extraFields = res.metadata_decoded.extra_fields;
                        const datahubURL = gitUrlCheck(extraFields.datahub_url.value);
                        const dir = `arc${expId}`;
                        await datahubClone(datahubURL, dir, params.datahubtoken);
                        await processExperiment(expIndex, expId, params, res, users, datahubURL);
                    }
                }
            } catch (error) {
              console.error(error);
                handleError(error);
            }
        }

        // Initialize UI elements
        function initializeUI() {
            filesChanged.innerHTML = "";
            statusInfo = "";
        }

        // Retrieve and validate parameters
        async function getParameters(elabidText, elabtoken, datahubtoken, instance ) {
            elabid = elabidText || document.getElementById("elabexperimentid").value;
            elabtoken = elabtoken || document.getElementById("elabToken").value;
            datahubtoken = datahubtoken || document.getElementById("datahubToken").value;

            setelabURL(instance);
            instance = unescape(instance);
            setCookies(elabidText, elabtoken, datahubtoken);
            elabidText = decodeURIComponent(elabidText);
            document.getElementById("elabexperimentid").value = elabidText;
            
            const elabidList = elabidText.split(",");

            
            return { elabidList, elabtoken, datahubtoken, instance };
        }

        async function processExperiment(expIndex, elabid, params, res, users, datahubURL, arcDir) {
          document.getElementById("statusModalBtn").click();
            const ratio = (parseInt(expIndex) + 1) / params.elabidList.length;
            updateInfo(`Fetching eLabFTW experiment <b>${elabid}</b>, instance is ${params.instance}`, ratio * 10);  
            window.elabJSON = res;

            const assayId = formatAssayId(res.title);
            user = users.find(e => e.fullname === res.fullname);
            const email = user.email;

            // Process protocol HTML
            let protocol = res.body;
            const elabWWW = params.instance.replace("api/v2/", "");
            protocol = protocol.replace( /app\/download\.php(.*)f=/g, "" );
            const protocolHTML = protocol;

            // Convert to markdown
            let markdown = turndownService.turndown(protocol);

            updateInfo(`DataHUB URL fetched from elabFTW's extra_field is "${datahubURL}"`, ratio * 20);
            
            const dir = arcDir ||`arc${elabid}`;

            const list = dir.split("/");
            const gitRoot = list[0]+"/";
            const gitSubfolder = dir.replace(list[0], "");
            console.log(gitRoot +"   git subfoler: "+ gitSubfolder);

            let ls;
            try {
              ls = fs.readdirSync(dir+"/assays")
            } catch (error) {
              ls = fs.readdirSync(dir)
            }
            
            //updateInfo("Assays are "+ ls.toString().replaceAll(",", "<br>") +". Updating assay <b>" + assayId+ "</b>", "30" );
            await createAssay(assayId, dir);
            // Initialize status HTML with protocol section
            let statusHTML = `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>eLabFTW Experiment ${elabid}</th>
                            <th>ARC files updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="protocolHTML">${protocolHTML}</td>
                            <td>
                                ARC file path is ${dir}/assays/${encodeURIComponent(assayId)}/protocols/eLabFTW_protocol.md
                                <br>
                                <a href="${datahubURL.slice(0, -4)}/-/blob/${mainOrMaster}/assays/${encodeURIComponent(assayId)}/protocols/eLabFTW_protocol.md" target="_blank">Click to check the file</a>
                            </td>
                        </tr>
            `;

            // Process uploads and update URLs
            [statusHTML, markdown] = await processUploadsAndReplaceUrls(
                res.uploads,
                dir, 
                gitRoot, 
                gitSubfolder,
                assayId,
                datahubURL,
                params,
                ratio,
                statusHTML,
                markdown,
                protocolHTML,
                elabid
            );

            // Finalize HTML and write files
            statusHTML += "</tbody></table>";
            statusHTML = statusHTML.replaceAll("<img", "<img class='img-fluid'");
            filesChanged.innerHTML = statusHTML;
            
            // Write markdown files

            await fs.promises.writeFile(`${dir}/assays/${assayId}/protocols/eLabFTW_protocol.md`, markdown);
            await git.add({ fs, dir: gitRoot, filepath: `${gitSubfolder}assays/${assayId}/protocols/eLabFTW_protocol.md` });
            await fs.promises.writeFile(`${dir}/assays/${assayId}/dataset/readme.md`, "# Data files");
            await git.add({ fs, dir: gitRoot, filepath: `${gitSubfolder}assays/${assayId}/dataset/readme.md` });
            finalizeExperimentDisplay(ratio);
            await commitPush(params.datahubtoken, datahubURL, res.fullname, email, dir,gitRoot);
            
        }

        // Process uploads and perform URL replacements
        async function processUploadsAndReplaceUrls(
            uploads,
            dir, 
            gitRoot, 
            gitSubfolder,
            assayId,
            datahubURL,
            params,
            ratio,
            statusHTML,
            markdown,
            protocolHTML,
            elabid,
        ) {
            for (const [index, upload] of Object.entries(uploads)) {
                const blob = await fetchElabFiles(
                    params.elabtoken,
                    `experiments/${window.elabJSON.id}/uploads/${upload.id}?format=´binary´`, //TODO, will be refined
                    params.instance
                );

                const objectURL = URL.createObjectURL(blob).replace(/&storage=./g, "");
                const realname = upload.real_name.replace(/[^a-zA-Z0-9_,\-+%$|(){}\[\]*=#?&$!^°<>;]/g, "_");
                const longname = upload.long_name;
                const longnameEncoded = encodeURIComponent(longname);
                const path = `assays/${assayId}/dataset/${index}_${realname}`;
                const markdownPath = `assays/${encodeURIComponent(assayId)}/dataset/${index}_${realname}`;

                // Replace URLs in protocol HTML
                statusHTML = statusHTML.replaceAll(longname, objectURL);
                statusHTML = statusHTML.replaceAll(longnameEncoded, objectURL);
                statusHTML = statusHTML.replace(/&amp;storage=[12]/g, "");

                // Replace URLs in markdown
                markdown = markdown.replace(new RegExp(longname, "g"), `${datahubURL.slice(0, -4)}/-/raw/${mainOrMaster}/${markdownPath}`);
                markdown = markdown.replace(new RegExp(longnameEncoded, "g"), `${datahubURL.slice(0, -4)}/-/raw/${mainOrMaster}/${markdownPath}`);
                markdown = markdown.replace(/&storage=./g, "");

                // Write file and update Git
                await fs.promises.writeFile(`${dir}/${path}`, new Uint8Array(await blob.arrayBuffer()));
                await git.add({ fs, dir: gitRoot, filepath: gitSubfolder+ path });

                // Update status HTML with file info
                if (blob.type.includes("image")) {
                    statusHTML += `
                        <tr>
                            <td><img src="${objectURL}"></td>
                            <td>Submitted ARC file path is: ${path}.<br>
                                <a href="${datahubURL.slice(0, -4)}/-/blob/${mainOrMaster}/${encodeURIComponent(path)}" target="_blank">Click to check the file</a>
                            </td>
                        </tr>
                    `;
                } else {
                    statusHTML += `
                        <tr>
                            <td>File name is ${realname}</td>
                            <td>Submitted ARC file path is: ${path}.<br>
                                <a href="${datahubURL.slice(0, -4)}/-/blob/${mainOrMaster}/${encodeURIComponent(path)}" target="_blank">Click to check the file</a>
                            </td>
                        </tr>
                    `;
                }

                updateInfo(`Added file ${realname}`, ratio * (10 + (index / uploads.length * 10)));
            }

            return [statusHTML, markdown];
        }
        // Format assay ID
        function formatAssayId(title) {
            return title.replace(/\//g, "|").replace(/[^a-zA-Z0-9_\-]/g, "_");
        }

        // Read directory contents
        async function readDirectory(dir) {
            try {
                return fs.readdirSync(`${dir}/assays`);
            } catch (error) {
                return fs.readdirSync(dir);
            }
        }


        // Finalize experiment display
        function finalizeExperimentDisplay(ratio) {
            updateInfo("Finished adding protocol files in ARC", ratio * 70);
            updateInfo("All files have been added to ARC, starting to push ARC to", ratio * 80);
            document.getElementById("filesAcc").click();

        }

        // Handle errors
        function handleError(error) {
            if (error.message.includes("401")) {
              
                showError("Error: Unable to access PLANTdataHUB. Please verify that the DataHub Token matches the datahub_url in the extra_fields of eLabFTW.");
            } else if (error.message.includes("Cannot read properties of undefined")) {
              
                showError("eLabFTW accessed successfully, but extra_fields is missing. Please check the experiment ID and extra_fields in eLabFTW.");
            } else if (error.message.includes("403")) {
              
                showError("Error: PLANTdataHUB cannot be accessed. Please verify that the datahub_url in the extra_fields of eLabFTW is correct.");
            } else {
              
                showError("Error: eLabFTW to ARC conversion failed.");
            }
            console.error(error);
            updateInfo("ARC update failed", 0);
        }

        async function fetchElabExperimentData(elabid, elabtoken, instance) {
          const res = await fetchElabJSON(elabtoken, `experiments/${elabid}`, instance);
          const users = await fetchElabJSON(elabtoken, "users", instance);
          const user = users.find(u => u.fullname === res.fullname);
          
          return {
            metadata: res,
            user,
            assayId: res.title.replace(/\//g, "|").replace(/[^a-zA-Z0-9_\-]/g, "_"),
            protocolMarkdown: turndownService.turndown(
              res.body.replace(/\w+\.php\?mode=view/g, `${instance.replace("/api/v2", "")}/$&`)
            )
          };
        }

 
      
    const loading = new bootstrap.Modal(document.getElementById('loadingModal'), {
      keyboard: true, show: false
    });

    addEventListener("load", (event) => { 
      
      //showError("sorry there is currently a connection problem between this tool and DataHUB, please try again later.")
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
      softRoute(); 
    
    }
    );

    function normalizePathSeparators (str) {
      const normalizedPath = path.normalize(str)
      return normalizedPath.replace(/\\/g, '/');
    }

    function memfsPathDirname(filePath) {
        if (typeof filePath !== 'string') filePath = String(filePath);
        if (filePath === '') return '.';

        // Remove trailing slashes (except if path is all slashes)
        let len = filePath.length;
        while (len > 0 && filePath[len - 1] === '/') len--;
        if (len === 0) return '/'; // Handle root path

        const normalized = filePath.slice(0, len);
        const lastSlashIndex = normalized.lastIndexOf('/');

        if (lastSlashIndex === -1) {
          // No directory separators found
          return (normalized === '.' || normalized === '..') ? normalized : '.';
        }

        // Slice to last slash and remove trailing slashes from the result
        let result = normalized.slice(0, lastSlashIndex);
        len = result.length;
        while (len > 0 && result[len - 1] === '/') len--;

        return len === 0 ? '/' : result.slice(0, len);
      }
      function memfsPathJoin(...segments) {
        // Filter out empty/null segments and join with '/'
        const joined = segments.filter(s => s != null && s !== '').join('/');

        // Split into components and normalize
        const stack = [];
        joined.split('/').forEach(segment => {
          if (segment === '.' || segment === '') return; // Skip no-ops
          if (segment === '..') {
            // Handle parent directory (if not at root)
            if (stack.length > 0 && stack[stack.length - 1] !== '') stack.pop();
          } else {
            stack.push(segment);
          }
        });

        // Rebuild path and remove trailing slash (except for root)
        let normalized = stack.join('/');
        if (normalized.endsWith('/') && normalized !== '') {
          normalized = normalized.slice(0, -1);
        }

        // Handle absolute paths
        const isAbsolute = joined.startsWith('/');
        return isAbsolute ? `/${normalized}` : normalized || '.';
      }

      async function arcWrite(arcPath, arc)  {
            let contracts = arc.GetWriteContracts()
            for (const contract of contracts) {
                // from Contracts.js docs
                await fulfillWriteContract(arcPath,contract)
            };
        }




    async function fulfillWriteContract (basePath, contract) {
        function ensureDirectory (filePath) {
            let dirPath = memfsPathDirname(filePath)
            if (!fs.existsSync(dirPath)){
                fs.mkdirSync(dirPath, { recursive: true });
            }
        }
        
        const p = memfsPathJoin(basePath,contract.Path)
        if (contract.Operation = "CREATE") {
            if (contract.DTO == undefined) {
                ensureDirectory(p)
                fs.writeFileSync(p, "")
            } else if (contract.DTOType == "ISA_Assay" || contract.DTOType == "ISA_Assay" || contract.DTOType == "ISA_Investigation") {
                ensureDirectory(p)
                await Xlsx.toFile(p, contract.DTO)
            } else if (contract.DTOType == "PlainText") {
                ensureDirectory(p)
                fs.writeFileSync(p, contract.DTO)
            } else {
                console.log("Warning: The given contract is not a correct ARC write contract: ", contract)
            }
        }
    }

    // Read

    async function fulfillReadContract (basePath, contract) {
      async function fulfill() {
          const normalizedPath = normalizePathSeparators(path.join(basePath, contract.Path))
          switch (contract.DTOType) {
              case "ISA_Assay":
              case "ISA_Study":
              case "ISA_Investigation":
                  let fswb = await Xlsx.fromXlsxFile(normalizedPath)
                  return fswb
                  break;
              case "PlainText":
                  let content = fs.load(normalizedPath)
                  return content
                  break;
              default:
                  console.log(`Handling of ${contract.DTOType} in a READ contract is not yet implemented`)
          }
      }
      if (contract.Operation == "READ") {
          return await fulfill()
      } else {
          console.error(`Error (fulfillReadContract): "${contract}" is not a READ contract`)
      }
    }



    function getAllFilePaths(basePath) {
      const filesList = []
      function loop (dir) {
          const files = fs.readdirSync(dir);
          for (const file of files) {
              const filePath = path.join(dir, file);
      
              if (fs.statSync(filePath).isDirectory()) {
                  // If it's a directory, recursively call the function on that directory
                  loop(filePath);
              } else {
                  // If it's a file, calculate the relative path and add it to the list
                  const relativePath = path.relative(basePath, filePath);
                  const normalizePath = normalizePathSeparators(relativePath)
                  filesList.push(normalizePath);
              }
          }
      }
      loop(basePath)
      return filesList;
    }




    // put it all together
    async function read(basePath) {
        let allFilePaths = getAllFilePaths(basePath)
        // Initiates an ARC from FileSystem but no ISA info.
        let arc = arctrl.ARC.fromFilePaths(allFilePaths)
        // Read contracts will tell us what we need to read from disc.
        let readContracts = arc.GetReadContracts()
        console.log(readContracts)
        let fcontracts = await Promise.all(
            readContracts.map(async (contract) => {
                let content = await fulfillReadContract(basePath, contract)
                contract.DTO = content
                return (contract) 
            })
        )
        arc.SetISAFromContracts(fcontracts);
        console.log(fcontracts);
        return arc
    }

    // execution

    // execution
    window.ARC2JSON= async function(ARCName, JSONname ){
        await read(ARCName).then(
            arc =>  {try {
                fs.writeFileSync(JSONname, arctrl.JsonController.Investigation.toISAJsonString(arc.ISA, void 0, true))
                // file written successfully
              } catch (err) {
                console.error(err);
              }}        
        )
    }

    window.fullAssay2= async function(assayName, tableName ="newtable", firstName=void 0, familyName=void 0, email= void 0, affiliation= void 0, comment="generated by elab2arc", dir ){
        try {
        // -------- 1. Create and manipulate object in datamodel ----------
        const growth = arctrl.ArcTable.init(tableName);
        // Add input column with one value to table
        growth.AddColumn(arctrl.CompositeHeader.input(arctrl.IOType.source()), [arctrl.CompositeCell.createFreeText("Input1")]);

        // Add characteristic column with one value
        const oa_species = new arctrl.OntologyAnnotation("species", "GO", "GO:0123456");
        const oa_chlamy = new arctrl.OntologyAnnotation("Chlamy", "NCBI", "NCBI:0123456");
        //growth.AddColumn(arctrl.CompositeHeader.characteristic(oa_species), [arctrl.CompositeCell.createTerm(oa_chlamy)]);


        // Create assay
        //const mtype = new arctrl.OntologyAnnotation("measurement type", "1", "2");
        //const mtech = new arctrl.OntologyAnnotation("technology type", "1", "2");
        //const mplat = new arctrl.OntologyAnnotation("technology platform", "1", "2");
        const roles = new arctrl.OntologyAnnotation("Researcher", "AGRO", "AGRO:00000373");

        let comments_p = arctrl.Comment$.create("generation log",comment);
        const person = arctrl.Person.create(void 0, firstName, familyName, void 0, email, void 0, void 0, void 0, affiliation, [roles], [comments_p]);
        let comments_m = arctrl.Comment$.create("name","value");
        
        // Create annotation table
        if (fs.existsSync(dir+"/assays/"+assayName+"/isa.assay.xlsx")){
         try {        
            console.log("isa.assay.xlsx file exist");
            assay = await Xlsx.fromXlsxFile(dir+"/assays/"+assayName+"/isa.assay.xlsx");
            isa_assay = await arctrl.XlsxController.Assay.fromFsWorkbook(assay);
            isa_assay.Performers = [person];
            isa_assay.Comment = [comments_m];
            let spreadsheet = arctrl.XlsxController.Assay.toFsWorkbook(isa_assay);
            const outPath = dir+"/assays/"+assayName+"/isa.assay.xlsx";

            console.log(spreadsheet);

            await Xlsx.toFile(outPath,spreadsheet);
         } catch (error) {
          console.log(error);
          
         }
        }else{
          //growth.AddColumn(arctrl.CompositeHeader.characteristic(oa_species), [arctrl.CompositeCell.createTerm(oa_chlamy )]);

          const myAssay = arctrl.ArcAssay.create(assayName, void 0, void 0, void 0, [growth], void 0,[person], [comments_m]);
          // -------- 2. Transform object to generic spreadsheet ----------
          let spreadsheet = arctrl.XlsxController.Assay.toFsWorkbook(myAssay);
          // -------- 3. Write spreadsheet to xlsx file (or bytes) ----------
          const outPath = dir+"/assays/"+assayName+"/isa.assay.xlsx";

          console.log(spreadsheet);

          await Xlsx.toFile(outPath,spreadsheet);
          }
        } catch (err) {
        console.error(err);
        }
    } 


      function showError(text){
        alert(text);
        updateInfo(text,"0")

      }

      function extractCookie(name){
        const cookie = document.cookie;
        const values = cookie.split("; ");
        let value = "";
        values.forEach(e=> { if (e.split("=")[0]===name){ value = e.split("=")[1]} }  );
        return value;
      }

      function softRoute() {
      const urlRoute = window.location.href.split("#");
      const url1 =  urlRoute[0].split("?")[1];
      console.log("submission url is "+ url1);
      try {
        if (url1){     
          console.log("submission url is "+ url1);   
        const submitData = url1.split("&");
        let submitJSON = {};
        submitData.forEach(e=>
        { submitJSON[e.split("=")[0]] = e.split("=")[1]}
      );
      // if (submitData.length =3 ){
      //   parseInt(submitJSON.elabid.toString())<1000 ? updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, "https://elabftw.hhu.de/api/v2/" ) : updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, window.localStorage.elabURL );
      // }else{
        updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, submitJSON.elabURL )
      // }
      } else {
      }
      try {
          const cookie = document.cookie;
          document.getElementById("elabexperimentid").value = decodeURIComponent(decodeURIComponent(extractCookie("elabid")));
          document.getElementById("elabToken").value = extractCookie("elabtoken");
          document.getElementById("datahubToken").value = extractCookie("datahubtoken");
        } catch (error) {
          console.error(error);
          
        }
      } catch (error) {
        showError("submission URL is wrong, error is " + error+". Please check your URL or remove everything after /elab2arc/")
      }
      
      
      const para = urlRoute.slice(-1)[0];
      switch (para) {
        case "elab":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "arc":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "arcTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "ftw":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "ftwTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "https://xrzhou.com/elab2arc/":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "http://127.0.0.1:8000/":
          window.location.href = "http://127.0.0.1:8000/elab2arc/"
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          
        default:

      }
      
      

    }

   




    async function cloneARC(http_url_to_repo, name) {
      loading.show()
      try {
        document.getElementById("gitlabInfo").innerHTML= http_url_to_repo;
        document.getElementById("arcInfo").innerHTML= name;
        datahubClone(http_url_to_repo, )
        const token = document.getElementById("datahubToken").value;
        // if (!token) {
        //   url = http_url_to_repo;
        //   console.log(url)
        // } else {
        //   [begin, end] =http_url_to_repo.split("//")
        //   url = begin + "//oath2:" + token + "@" + end;
        //   console.log(url);
        // }
        await datahubClone(http_url_to_repo, name, token)
        // let date = Date().replaceAll(" ", "_").replaceAll(":", "-").split("(")[0];
        // let dir = "/" + url.split("/").slice(-1)[0] + date
        // FS.mkdirSync(dir);
        // window.current_file = dir;
        // const res = await git.clone({
        //   fs,
        //   http,
        //   dir,
        //   corsProxy: 'https://gitcors.cplantbox.com',
        //   url: url,
        //   ref: 'main',
        //   singleBranch: true,
        //   depth: 1,
        //   force: true,
        //   onProgress: event => {
        //     updateLabel(event.phase)
        //     if (event.total) {
        //       updateProgressBar(event.loaded / event.total)
        //     } else {
        //       //updateIndeterminateProgressBar(event.loaded)
        //     }
        //   }
        // });
        refreshTree();
        // let tableHTML="";
        // const fileList = fs.readdirSync("/");
        // fileList.forEach((element, index) => {
        //   if (!element.endsWith(".json")){
        //     const fileName = element.split(".git");
        //   tableHTML += `
        //         <tr>
        //         <td>
        //       `+ fileName[0] + `
        //         </td>
        //         <td>
        //      `+ fileName[1] + `
        //         </td>
        //         <td>  
        //       <button type="button" onclick=" runARC2JSON('`+ element + `')" class="btn btn-primary"> Update ARC </button>
        //       </td>
        //     </tr>
        //     `
        //   }
          
        // });
        // document.getElementById("importedARCTable").innerHTML= tableHTML;
        
      } catch (error) {
        
        throw showError(error),
        console.error(error);
      }

      loading.hide();

    }

    function updateLabel(phrase) {
      document.getElementById("pbarLabel").innerHTML = phrase;
    }
    function updateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
    function updateIndeterminateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }

    addEventListener("hashchange", (event) => {
      if (true) {
        softRoute();
      }
    });
  </script>


  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true" style="z-index:1001">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">

            <div class="form-check" id="submitRepos">
              
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="1" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        Fetch eLabFTW 

                      </label>


                    </div>
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>




                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ena" name="repo">
                      <label class="form-check-label" for="ENA">
                        Clone ARC
                      </label>
                    </div>
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>



                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Update ARC and Resubmit
                      </label>
                    </div>


                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>


              </div>


            
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="Array.from(document.querySelectorAll('input[name=repo]:checked')).forEach((e)=> submitAll(e.id, window.input_json)) ">Submit</button>
        </div>
      </div>
    </div>
  </div>


  <div class="offcanvas offcanvas-start w-50" tabindex="-1" id="experimentIdCanvas" aria-labelledby="experimentIdCanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="experimentIdCanvasLabel">eLabFTW Experiment Id</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div>
        ELabFTW experiment ID can be found in the address bar or in the experiment description. 
        <br>
        <img src="https://nfdi4plants.github.io/elab2arc/images/experimentId.png" class="rounded mx-auto d-block w-100" alt="...">
        A detailed user guide can be found <a target="_blank" href="https://github.com/nfdi4plants/elab2arc/blob/main/docs/User%20guide_%20elab2ARC%20tool.md"> here </a>
      </div>
      
    </div>
  </div>
  

  <div class="offcanvas offcanvas-start w-50" tabindex="-1" id="elabTokenCanvas" aria-labelledby="elabTokenCanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="elabTokenCanvasLabel">eLabFTW API keys </h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div>
        eLabFTW API keys can be generated from settings -> API keys  
        <br>
        <img src="https://nfdi4plants.github.io/elab2arc/images/elabToken.png" class="rounded mx-auto d-block w-100" alt="...">
        <br>
        The access token will be displayed only once, so make sure to store it securely. Treat it like a password, as anyone with the token can access eLabFTW. 
        <br>
        A detailed user guide can be found <a target="_blank" href="https://github.com/nfdi4plants/elab2arc/blob/main/docs/User%20guide_%20elab2ARC%20tool.md"> here </a>
      </div>
      
    </div>
  </div>

  <div class="offcanvas offcanvas-start w-50" tabindex="-1" id="datahubTokenCanvas" aria-labelledby="datahubTokenCanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="datahubTokenCanvasLabel">eLabFTW API keys </h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div>
        To generate a DataHub access token, go to Settings → Access Tokens → Create. Set the Role to "Maintainer" and select the Scopes: "read_repository" and "write_repository."
        <br>
        <img src="https://nfdi4plants.github.io/elab2arc/images/datahubToken.png" class="rounded mx-auto d-block w-100" alt="...">
        <br>
        The access token will be displayed only once, so make sure to store it securely. Treat it like a password, as anyone with the token can access and modify the DataHUB repo. 
        <br>
        A detailed user guide can be found <a target="_blank" href="https://github.com/nfdi4plants/elab2arc/blob/main/docs/User%20guide_%20elab2ARC%20tool.md"> here </a>
      </div>
      
    </div>
  </div>

  
</body>
<script>

</script>

</html>