<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="elab2ARC, convert eLabFTW experiments to ARCs">
  <meta name="keywords" content="elab2ARC">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" type="image/x-icon" href="favicon.png">
  <style>
    .center {
      position: relative;
      text-align: center;
    }



    .uploadarea {

      padding: 6px;
      border: 4px solid #4fb3d9;
      border-style: outset;
      border-radius: 5px;
      -khtml-opacity: 0.5;
      -moz-opacity: 0.5;
      opacity: 0.5;
      height: 20vh;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234fb3d9' class='bi bi-cloud-upload' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383'/><path fill-rule='evenodd' d='M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z'/></svg>");
      background-position: center;
      background-repeat: no-repeat;
      background-size: 64px 64px;

    }

    td {
      overflow-wrap: break-all;
      word-break: break-all;
    }

    datalist {
      display: flex;
      justify-content: space-between;
      color: #4fb3d9;
      width: 100%;
    }

    .uploadarea:hover,
    .uploadarea.dragging,
    .uploadarea.uploading {
      filter: alpha(opacity=100);
      -khtml-opacity: 1;
      -moz-opacity: 1;
      opacity: 1;
    }

    .uploadarea input {
      margin: auto;
      width: 100%;
      height: 100%;

      border: none;
      cursor: pointer;
      opacity: 0;
    }

    .uploadarea input:focus {
      outline: none;
    }

    span.json {
      display: inline-block;

      margin: 4px;
      padding: 6px;
      border: 4px solid #4fb3d9;
      border-style: solid;
      border-radius: 5px;
    }

    *[title]:hover:after {
      background-color: #4fb3d9;
      content: attr(name) '\A' attr(description);
      z-index: 1;
      position: absolute;

    }

    span.studies {
      background-color: #fff9e6;

    }

    span.collapsed {
      font-weight: bold;
      border: 4px #4fb3d9;
      border-style: inset;
      box-shadow: 0 8px 6px -6px #4fb3d9;
      cursor: pointer;
    }

    span.missingKey {
      font-weight: bold;
      border: 4px #b005ad;
      border-style: dotted;
      box-shadow: 0 8px 6px -6px #c50070;
    }

    span.collapsed::before {
      content: "+";
      color: #4fb3d9;
    }

    span.assays {
      background-color: #F8E8EB;

    }

    .form-range {
      appearance: auto !important;
    }

    input[type="range"]::-webkit-slider-thumb {

      height: 15px;
      width: 15px;
      background-color: #fff;
      border-radius: 50%;
      border: 2px solid #4fb3d9;

    }

    input[type="range"]::-moz-range-thumb {
      height: 15px;
      width: 15px;
      background-color: #fff;
      border-radius: 50%;
      border: 1px solid #4fb3d9;


    }

    input[type="range"]::-moz-range-track {
      padding: 0 10px;
      background: repeating-linear-gradient(to right,
          #ccc,
          #ccc 10%,
          #000 10%,
          #000 11%,
          #ccc 11%,
          #ccc 20%);
    }

    .scrollTable{
      max-height : 200px;
      overflow-y: scroll;
      max-width: 80vw;
    }
    button:hover span{
       content: "under construction" !important; 
      }

  </style>  
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <script src="./js/bootstrap.bundle.min.js"></script>
  <link href="./css/custom2607.css" rel="stylesheet" />
  <link href="./css/bs5-intro-tour.css" rel="stylesheet" />
  <script src="./js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/git.js"></script>
  <script src="./js/main060924.js" type="text/javascript"></script>
  <script src="./js/turndown.js" type="text/javascript"></script>
  <script type="module">
    import http from './js/http.js'
    window.http = http;
    // window.fs = new LightningFS('fs')
    // window.pfs = window.fs.promises
  </script>


</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>
    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group d-md-none g-0 dropdown col-auto d-flex align-items-center" style="">
        <button type="button" class="btn rounded-0 border-0 g-0 btn-nav " data-bs-toggle="dropdown"
          aria-expanded="false" id="menu">
          Menu &nbsp;
          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="convertershort" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlinkshort" class="dropdown-item" href="elab2ARC">GitHub</a>
          </li>
          <li>
            <a id="usshort" class="dropdown-item" onclick=''>About Us</a>
          </li>

        </ul>
      </div>

      <div class="btn-group d-none g-0 d-md-block dropdown col-auto">
        
        <button type="button" onclick="location.href=location.href.split('#')[0]+'#elab'" class="btn  btn-nav"
        id="submitNavBtn">
        Fetch eLabFTW &nbsp;
      </button>
      
        <button class="btn btn-nav dropdown-toggle" id="instance" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          eLabFTW Instance: HHU
        </button>
        <ul class="dropdown-menu">
          <li><button class="dropdown-item" onclick="setelabURL('https://demo.elabftw.net/api/v2/') " type="button">eLabFTW Instance: Demo</button></li>
          <li><button class="dropdown-item" onclick=" setelabURL('https://elabftw.hhu.de/api/v2/')" type="button">eLabFTW Instance: HHU</button></li>
        </ul>
      
        <button type="button" onclick="location.href=location.href.split('#')[0]+'#arc'" class="btn btn-nav d-none"
          id="a2jNavBtn">
          Fetch ARCs&nbsp;
        </button>
        


        <button type="button" onclick="location.href=location.href.split('#')[0]+'#submit'" class="btn  btn-nav d-none"
          id="isacheckNavBtn">
          Update ARC and Resubmit &nbsp;
        </button>

        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converterlong" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlinklong" class="dropdown-item" href="https://github.com/xiaoranzhou/elab2arc/tree/main">GitHub</a>
          </li>
          <li>
            <a id="aboutlong" class="dropdown-item d-none" href=''>About</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container">
    <div name="tab" class=" col-12 justify-content-center nav-link text-center" id="introTab">
      <a href="#elab">
        <h1>Fetch eLabFTW experiments </h1>
      </a>
     
     
    </div>

    <div name="tab" class="row justify-content-center d-none" id="elabTab">
      <h1 class="center"> eLabFTW to ARC </h1>


      <form id="authForm"  action="/elab2arc/#elab" class="row justify-content-center">
        <div class="mb-3 col-lg-2">
          <label for="elabexperimentid" class="form-label">eLabFTW Experiment ID</label>
          <input type="text"  name="elabid" class="form-control" autocomplete="username"  id="elabexperimentid" aria-describedby="elabexpHelp" required>
          <div id="elabexpHelp" class="form-text d-none">Experiment ID can be found in the address bar of the browser.
          </div>
        </div>
        <div class="mb-3 col-lg-2">
          <label for="elabToken" class="form-label">eLabFTW API Key</label>
          <input type="text" name="elabtoken" class="form-control" autocomplete="password"  id="elabToken" required>
        </div>

        <div class="mb-3 col-lg-2">
          <label for="datahubToken" class="form-label">DataHub Access Token</label>
          <input type="text" name="datahubtoken" class="form-control" autocomplete="password"  id="datahubToken" required>
        </div>

        <div class="mb-3 col-lg-2 d-none">
          <label for="elabURLInput" class="form-label">elabURL</label>
          <input type="text" name="elabURL" value="https://elabftw.hhu.de/api/v2/" class="form-control" autocomplete="password"  id="elabURLInput" required>
        </div>

        <div class="mb-3 col-lg-4">
          <label for="elabsubmit" class="form-label">Submit Options</label><br>
         
            
            <button class="btn btn-primary"  type="submit" data-bs-toggle="collapse" data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus" > One Click Submission </button>
            <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-title="Under Construction">
            <button type="button" class="btn btn-primary"  disabled><span> Step by Step </span></button>
          </span>

         
                   
        </div>
        
      </form>
      <div id="toolstatus"  class="col-10 m-auto">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbarModal" role="progressbar"
            aria-label="Animated striped example" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"
            style="width: 1%">
          </div>
        </div>
        <div class="accordion" id="accordionUI">
          <div class="accordion-item">
            <h2 class="accordion-header" id="statusHeading">
              <button class="accordion-button" id="pbarLabel" type="button" data-bs-toggle="collapse" data-bs-target="#submitStatus" aria-expanded="true" aria-controls="submitStatus">
                Submission Status

              </button>

            </h2>
            <div id="submitStatus" class="accordion-collapse collapse" aria-labelledby="statusHeading" data-bs-parent="#accordionUI">
              <div class="accordion-body" id="detailedStatus">

              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="elabHeading">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" id="filesAcc" data-bs-target="#elabInfo" aria-expanded="true" aria-controls="elabInfo">
                Files Changed in ARC 

              </button>
             
            </h2>
            <div id="elabInfo" class="accordion-collapse collapse" aria-labelledby="elabHeading" data-bs-parent="#accordionUI">
              <div class="accordion-body">
                <div class="center" id="filesChanged">
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row justify-content-center m-3">
        <img id="bbb"></img>
      </div>
      
    </div>

    <div name="tab" class=" col-12 d-none" id="arcTab">
      <div class="" style="height: 50vh; overflow-y: scroll">

        <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
          <thead>
            <tr>
              <th scope="col">Number</th>
              <th scope="col">User/Group</th>
              <th scope="col">Repo Name</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="datahubTable">
          </tbody>
        </table>
      </div>
      <div class="row m-3">
        <div class="col-5">
          <h4> Imported ARCs </h4>
          <table class="table table-striped table-hover" style="table-layout:auto ; width:100%; ">
            <thead>
              <tr>
                <th scope="col">ARC Name</th>
                <th scope="col">Import Time</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="importedARCTable">
            </tbody>
          </table>
        </div>
        <div class="col-7">

         
        </div>
      </div>
      <div id="ARCInfo" class="row m-auto">

      </div>


    </div>
    <div name="tab" class=" col-8 d-none align-items-center m-auto" id="updateTab">

      <div class=" area uploadarea my-3" id="importArea" ondragenter="this.className='area uploadarea dragging'"
        ondrop=";DragAndDrop(event)" style=" width:100%">


        <input type="file" id="import" multiple>
      </div>
      <div class="text-center m-auto">
        <button class="text btn btn-primary d-none" id="toSubmit" onclick="location.href=location.href.split('#')[0]+'#submit'" > 
          Start Submission
        </button>
      </div>
      <div id="alertPlace"> </div>
      
      
    </div>
  </div>
  <button type="button" class="btn btn-primary d-none" id="loadingModalBtn" data-bs-toggle="modal"
    data-bs-target="#loadingModal">
    Launch loading modal
  </button>
  <div class="modal" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="#loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="loadingModalLabel">Processing</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>


          </div>
         

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    var fs = FS.fs;
    var elabJSON;
    var statusInfo;
    const version = "24-09-04";
    var blobb = [];
    
    const detailedInfo = document.getElementById("detailedStatus");
    const filesChanged =document.getElementById("filesChanged");
    
    var turndownService = new TurndownService();
    var mainOrMaster = "main";
    turndownService.keep(['table']);
    function setelabURL(elabURL){

      window.localStorage.setItem('elabURL',elabURL); 
      document.getElementById('elabURLInput').value=elabURL ;
      document.getElementById('instance').innerHTML = 'instance: '+elabURL; 
      document.getElementById('elabURLInput').value = elabURL;
    }
    async function fetchElabJSON( elabToken, query='experiments/',  elabURL , corsproxy ='https://corsproxy.cplantbox.com/'){
      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;
      // Define the API key      
      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'x-requested-with'};
      // Make the fetch request      
      try {
       const response = await fetch(elabftwServerUrl, { headers, method: 'GET'});
       const json = await response.json();
       return json;
      } catch (error) {
        if (error.message.includes(`Unexpected token 'N', "No corresp"... is not valid JSON`)){
          showError("Access of eLabFTW is not successful, the eLabFTW API key might be wrong, please go to settings to create a new API key and use it");
        }else{
          showError("Access of eLabFTW is not successful, error message is "+ error);
        }
        return error;
      }
    }

    async function fetchElabFiles( elabToken, query='experiments/',  elabURL, corsproxy ='https://corsproxy.cplantbox.com/' ){
      // Define the API endpoint
      const elabftwServerUrl = corsproxy + elabURL + query;
      // Define the API key
      const headers = {'accept': 'application/json', 'Authorization': elabToken, 'Origin': 'x-requested-with'};
      // Make the fetch request
      try {
      var response = await fetch(`${elabftwServerUrl}`, { headers, method: 'GET'});
      return response.blob();
      } catch (error) {
        if (error.message.includes(`Unexpected token 'N', "No corresp"... is not valid JSON`)){
          showError("Access of eLabFTW is not successful, the eLabFTW API key might be wrong, please go to settings to create a new API key and use it");
        }else{
          showError("Access of eLabFTW is not successful, error message is "+ error);
        }
        
        return error;
      }
      }
    
    function gitUrlCheck(url){
      if (/(?:git|ssh|https?|git@[-\w.]+):(\/\/)?(.*?)(\.git)(\/?|\#[-\d\w._]+?)$/.test(url)){
        updateInfo("DataHub URL collected successfully" ,"30");
        return url;
      }
      else{
        updateInfo("DataHub URL is not correct, automatic patches are done " ,"30");
        if (!url.endsWith(".git")){
        url = url + ".git";
        updateInfo("Added \" .git\" at the end, current url is "+ url ,"30");
      }
      if (!url.startsWith("https://")){
        url = "https://" + url ;
        updateInfo("Added \" https:// \" at the start, current url is "+ url ,"30");
      }
      return url;
      }
      
    }
    
    async function datahubClone(datahubURL, dir, datahubtoken){
      const [begin, end] = datahubURL.split("//");
      url = begin + "//oath2:" + datahubtoken + "@" + end;
          console.log(url);
      try {
        const cloneResponse = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://cors.isomorphic-git.org',
          url: url,
          ref: 'main',
          singleBranch:true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(50 + (event.loaded / event.total)*30)
            } else {
              updateIndeterminateProgressBar(50 + (event.loaded / 100)*30)
            }
          }
        });
        mainOrMaster = "main";
      } catch (error) {
        updateInfo("Clone branch main failed, now try to clone branch master", "50")
        const cloneResponse = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://cors.isomorphic-git.org',
          url: url,
          ref: 'master',
          singleBranch:true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(50 + (event.loaded / event.total)*30)
            } else {
              updateIndeterminateProgressBar(50 + (event.loaded / 100)*30)
            }
          }
        });
        mainOrMaster = "master";
      }
      
    }

    async function commitPush( datahubtoken, datahubURL, fullname, email ){
      let sha = await git.commit({
          fs,
          dir: '/arc',
          author: {
            name: fullname,
            email: email,
          },
          message: "Automatically commited by eLabFTW2ARC tool with version"+ version +".  "+ statusInfo
        });
        console.log("commit finished");
        try {
          let pushResult = await git.push({
          fs,
          http,
          dir: '/arc',
          remote: 'origin',
          force: true,
          ref: 'main',
          onAuth: () => ({ username: datahubtoken }),
        });
        console.log(pushResult)  ;
        updateInfo("Success pushed", "100")
        //
        } catch (error) {
          updateInfo( error+" Push to main failed, now try to push to branch master", "0");
          let pushResult = await git.push({
          fs,
          http,
          dir: '/arc',
          force: true,
          remote: 'origin',
          ref: 'master',
          onAuth: () => ({ username: datahubtoken }),
        });
        console.log(pushResult)  ;
        showError( datahubURL +"ARC has been updated")
          //showError( "push to git failed. The error is "+ error)
        }
    }
    
    async function createAssay(assayId){
      try {
        fs.statSync("arc/assays/"+assayId+"/protocols");
      } catch (error) {
        fs.mkdirSync("arc/assays/"+assayId+"/protocols",{ recursive: true } )
      };
      try {
        fs.statSync("arc/assays/"+assayId+"/dataset");
      } catch (error) {
        fs.mkdirSync("arc/assays/"+assayId+"/dataset",{ recursive: true } )
      } 
      
    }

    function updateInfo(text, percent){
      updateLabel(text);
      updateProgressBar(percent);
      const event = new Date();
      statusInfo += event.toLocaleString('en-GB', { timeZone: 'UTC' }) +"&nbsp; &nbsp; &nbsp;" + text +"\t " + "<br>";
      detailedInfo.innerHTML = statusInfo;       
    }

    async function updateAll(elabid, elabtoken, datahubtoken, instance="https://elabftw.hhu.de/api/v2/"){
      try {   
      filesChanged.innerHTML="";
      statusInfo = "";
      elabid = elabid || document.getElementById("elabexperimentid").value;
      elabtoken = elabtoken || document.getElementById("elabToken").value;
      datahubtoken = datahubtoken || document.getElementById("datahubToken").value;
      setelabURL(instance);
      const maxage = 60*60*24*31; //max age is one month
      document.cookie = "elabid="+elabid+"; SameSite=lax; max-age=2678400; Secure";
      document.cookie = "elabtoken="+elabtoken+"; SameSite=lax; max-age=2678400; Secure";
      document.cookie = "datahubtoken="+datahubtoken+"; SameSite=lax; max-age=2678400; Secure";
      updateInfo("Start to fetch metadata from eLabFTW, instance is "+instance, "10" );
      
      const res = await fetchElabJSON(elabtoken, "experiments/"+elabid,  instance);
      const users = await fetchElabJSON(elabtoken, "users", instance);
      const extra_fields = res.metadata_decoded.extra_fields;
      const datahubURL = gitUrlCheck(extra_fields.datahub_url.value);;
      // const assayId  = res.title.replaceAll(".", "-dot-").replaceAll("/", "-slash-");
      const assayId  = res.title.replaceAll(/[^a-zA-Z0-9 ]/g, " ");
      const fullname = res.fullname;
      const user = users.find(e=> e.fullname == fullname)
      const email = user.email;
      let protocol = res.body;
      const elabWWW= instance.replace("api/v2/", "");
      protocol = protocol.replaceAll(/\w+\.php\?mode=view/g, elabWWW+"/$&"  )
      console.log("protocol is" + protocol)
      let markdown = turndownService.turndown(protocol);
      updateInfo("DataHUB URL fetched from elab is \""+datahubURL, "\" 20" );
      
      const dir ="arc";
      await datahubClone(datahubURL, dir, datahubtoken);
      const ls = fs.readdirSync("arc")
      updateInfo("ARC successfully loaded, files are "+ ls +". Starting to add eLabFTW files to assays " + assayId, "30" );
      await createAssay(assayId);
      // try {
      //   fs.statSync("arc/assays/"+assayId+"/isa.assay.xlsx");
      //   updateInfo("isa.assay.xlsx detected.", "35");
      // } catch (error) {
      //   await fullAssay(assayId, "new metadata table", res.firstname, res.lastname, email, res.team_name, "Generated by elab2ARC tool" );
      //   updateInfo("No isa.assay.xlsx. Generated new assays/"+assayId+"new isa.assay.xlsx", "35");
      // } 
      await fullAssay2(assayId, "new metadata table", res.lastname, res.firstname, email, res.team_name, "Generated by elab2ARC tool on "+Date() );
        updateInfo("No isa.assay.xlsx. Generated new assays/"+assayId+"new isa.assay.xlsx", "35");
      await git.add({ fs, dir: dir, filepath: "assays/"+assayId+"/isa.assay.xlsx"})
      statusHTML =  
      `
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            
            <th scope="col">eLabFTW text and files</th>
            <th scope="col">ARC files updated</th>
          </tr>   
      </thead>
        <tbody>
          <tr>
            <td id="protocolHTML">
            `+ protocol +`
            </td>
            <td>
              ARC file path is arc/assays/`+assayId+`/protocols/eLabFTW_protocol.md
               <br>
              <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/assays/`+assayId+`/protocols/eLabFTW_protocol.md" target="_blank" >click to check the file</a>
            </td>  
          </tr>     
      `

      const uploads = res.uploads;
      let fileList = [];
      //let filedict = {};
      for (const [index, ele] of Object.entries(uploads)){
        const blobs = await fetchElabFiles( elabtoken, "experiments/"+ elabid+ "/uploads/"+ ele.id +"?format=´binary´",instance);
        blobb.push(blobs);
        const objectURL = URL.createObjectURL(blobs);        
        let data = new Uint8Array(await blobs.arrayBuffer());
        // const extension = blobs.type.split("/").slice(-1)[0];
        const realname =  ele.real_name;
        const longname = ele.long_name;
        const path = "assays/"+assayId+"/dataset/"+index+"_"+realname;
        //filedict[longname] = datahubURL.slice(0,-4)+`/-/raw/main/`+path;

        statusHTML = statusHTML.replaceAll( "app/download.php?f="+longname , objectURL );
        markdown = markdown.replaceAll( "app/download.php?f="+longname , datahubURL.slice(0,-4)+`/-/raw/`+mainOrMaster+`/`+path );
        await fs.promises.writeFile(dir+"/"+path , data);
        await git.add({ fs, dir: dir, filepath: path });
        
        updateInfo("Added file " + realname, 50+(index/uploads.length * 30) );
        if(blobs.type.includes("image") ){
          statusHTML +=  
        `
          <tr>
            <td>
              <img  src="`+ objectURL +`">
            </td>
            <td>
              Submitted
              ARC file path is: `+path+`.
              <br>
              <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/`+path+`" target="_blank" >click to check the file</a>
            </td>
          </tr>

        `
          } else {
            statusHTML +=  
        `
          <tr>
            <td>
              file name is `+realname+` 
            </tb>
            <td>
              Submitted
              ARC file path is: `+path+`.
              <br>
              <a href="`+datahubURL.slice(0,-4)+`/-/blob/`+mainOrMaster+`/`+path+`" target="_blank" >click to check the file</a>
            </td>
          </tr>

        `
          }
        }
        
        await fs.promises.writeFile('arc/assays/'+assayId+'/protocols/eLabFTW_protocol.md' , markdown);
        
        await git.add({ fs, dir: dir, filepath: 'assays/'+assayId+'/protocols/eLabFTW_protocol.md' });
        await fs.promises.writeFile('arc/assays/'+assayId+'/dataset/readme.md' , "# Data files");
        await git.add({ fs, dir: dir, filepath: "assays/"+assayId+"/dataset/readme.md"})
        updateInfo("Finished adding protocol files in ARC", "70" );
        updateInfo("All files have been added to ARC, starting to push ARC to DataHUB "+instance, "80" );
        console.log('done')
        await commitPush(datahubtoken, datahubURL, fullname, email );
        updateInfo("ARC updated Successfully" , "100" );
        document.getElementById("filesAcc").click();
        statusHTML += "</tbody> </table>";
        statusHTML = statusHTML.replaceAll( "<img", "<img class='img-fluid'" );
        filesChanged.innerHTML = statusHTML;

      } catch (error) {
        if (error.message.includes("401")){
          showError( "ELabFTW to ARC conversion failed, error is "+ error+". Please check the DataHub Token is matched to the datahub_url in the eLabFTW extra_fields. ");
        }else{
          showError( "ELabFTW to ARC conversion failed, error is "+ error);
        }
        updateInfo("ARC updated failed" , "0" );
      }      
    }

    addEventListener("hashchange", (event) => {
      if (true) {
        softRoute();
      }
    });
      
    const loading = new bootstrap.Modal(document.getElementById('loadingModal'), {
      keyboard: true, show: false
    });

    addEventListener("load", (event) => { 
      
      //showError("sorry there is currently a connection problem between this tool and DataHUB, please try again later.")
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
      softRoute(); 
    
      // try{var repoList;
    // fetch('https://git.nfdi4plants.org/api/v4/projects')
    //   .then(data => {
    //     if (data.status >= 400 && data.status < 600) {
    //   throw showError("Bad response from server, please check the availability of the server");
    //     }
    //     return data.json();
    //   })
    //   .then(post => {
    //     window.repoList = post;
    //     var tableHTML = '';
    //     let newIndex = 0;        
    //     post.forEach((element, index) => {
    //       if (element.description !== null) {
    //         const pathName = element.path_with_namespace.split("/");
    //         newIndex += 1;
    //         tableHTML += `
    //     <tr>
    //       <th scope="row">`+ newIndex + ` </th>
    //       <td>
    //       `+ pathName[0] + `
    //         </td>
    //          <td>
    //       <a href="`+ element.web_url + `" target="_blank">` + pathName[1] + `</a>
    //         </td>
    //          <td>
    //           <div class="btn-group" role="group" aria-label="Basic example">          
    //       <button type="button" onclick="document.getElementById('repoURL').value='`+ element.http_url_to_repo + `'; cloneARC(false)" class="btn btn-secondary">Import ARC</button>  
    //       </div>
    //       </td>
    //     </tr>
    //     `
    //       }
    //     }), document.getElementById("datahubTable").innerHTML = tableHTML;
    //   }).catch((error) => {
    //       // Your error is here!
    //       showError(error)
    //     });}catch(e){
    //     showError(e);
    //   }
    }
    );

    function normalizePathSeparators (str) {
      const normalizedPath = path.normalize(str)
      return normalizedPath.replace(/\\/g, '/');
    }


    async function fulfillWriteContract (basePath, contract) {
        function ensureDirectory (filePath) {
            let dirPath = path.dirname(filePath)
            if (!fs.existsSync(dirPath)){
                fs.mkdirSync(dirPath, { recursive: true });
            }
        }
        const p = path.join(basePath,contract.Path)
        if (contract.Operation = "CREATE") {
            if (contract.DTO == undefined) {
                ensureDirectory(p)
                fs.writeFileSync(p, "")
            } else if (contract.DTOType == "ISA_Assay" || contract.DTOType == "ISA_Assay" || contract.DTOType == "ISA_Investigation") {
                ensureDirectory(p)
                await Xlsx.toFile(p, contract.DTO)
            } else if (contract.DTOType == "PlainText") {
                ensureDirectory(p)
                fs.writeFileSync(p, contract.DTO)
            } else {
                console.log("Warning: The given contract is not a correct ARC write contract: ", contract)
            }
        }
    }

    // Read

    async function fulfillReadContract (basePath, contract) {
      async function fulfill() {
          const normalizedPath = normalizePathSeparators(path.join(basePath, contract.Path))
          switch (contract.DTOType) {
              case "ISA_Assay":
              case "ISA_Study":
              case "ISA_Investigation":
                  let fswb = await Xlsx.fromXlsxFile(normalizedPath)
                  return fswb
                  break;
              case "PlainText":
                  let content = fs.load(normalizedPath)
                  return content
                  break;
              default:
                  console.log(`Handling of ${contract.DTOType} in a READ contract is not yet implemented`)
          }
      }
      if (contract.Operation == "READ") {
          return await fulfill()
      } else {
          console.error(`Error (fulfillReadContract): "${contract}" is not a READ contract`)
      }
    }



    function getAllFilePaths(basePath) {
      const filesList = []
      function loop (dir) {
          const files = fs.readdirSync(dir);
          for (const file of files) {
              const filePath = path.join(dir, file);
      
              if (fs.statSync(filePath).isDirectory()) {
                  // If it's a directory, recursively call the function on that directory
                  loop(filePath);
              } else {
                  // If it's a file, calculate the relative path and add it to the list
                  const relativePath = path.relative(basePath, filePath);
                  const normalizePath = normalizePathSeparators(relativePath)
                  filesList.push(normalizePath);
              }
          }
      }
      loop(basePath)
      return filesList;
    }




    // put it all together
    async function read(basePath) {
        let allFilePaths = getAllFilePaths(basePath)
        // Initiates an ARC from FileSystem but no ISA info.
        let arc = arctrl.ARC.fromFilePaths(allFilePaths)
        // Read contracts will tell us what we need to read from disc.
        let readContracts = arc.GetReadContracts()
        console.log(readContracts)
        let fcontracts = await Promise.all(
            readContracts.map(async (contract) => {
                let content = await fulfillReadContract(basePath, contract)
                contract.DTO = content
                return (contract) 
            })
        )
        arc.SetISAFromContracts(fcontracts);
        console.log(fcontracts);
        return arc
    }

    // execution

    // execution
    window.ARC2JSON= async function(ARCName, JSONname ){
        await read(ARCName).then(
            arc =>  {try {
                fs.writeFileSync(JSONname, arctrl.JsonController.Investigation.toISAJsonString(arc.ISA, void 0, true))
                // file written successfully
              } catch (err) {
                console.error(err);
              }}
        
        
        
        )
    }

    window.fullAssay2= async function(assayName, tableName ="newtable", firstName=void 0, familyName=void 0, email= void 0, affiliation= void 0, comment="generated by elab2arc" ){
        try {
        // -------- 1. Create and manipulate object in datamodel ----------



        const growth = arctrl.ArcTable.init(tableName);
        // Add input column with one value to table
        growth.AddColumn(arctrl.CompositeHeader.input(arctrl.IOType.source()), [arctrl.CompositeCell.createFreeText("Input1")]);

        // Add characteristic column with one value
        const oa_species = new arctrl.OntologyAnnotation("species", "GO", "GO:0123456");
        const oa_chlamy = new arctrl.OntologyAnnotation("Chlamy", "NCBI", "NCBI:0123456");
        //growth.AddColumn(arctrl.CompositeHeader.characteristic(oa_species), [arctrl.CompositeCell.createTerm(oa_chlamy)]);


        // Create assay
        //const mtype = new arctrl.OntologyAnnotation("measurement type", "1", "2");
        //const mtech = new arctrl.OntologyAnnotation("technology type", "1", "2");
        //const mplat = new arctrl.OntologyAnnotation("technology platform", "1", "2");
        const roles = new arctrl.OntologyAnnotation("Researcher", "AGRO", "AGRO:00000373");

        let comments_p = arctrl.Comment$.create("generation log",comment);
        const person = arctrl.Person.create(void 0, firstName, familyName, void 0, email, void 0, void 0, void 0, affiliation, [roles], [comments_p]);
        let comments_m = arctrl.Comment$.create("name","value");
        
        // Create annotation table
        if (fs.existsSync("/arc/assays/"+assayName+"/isa.assay.xlsx")){
         try {        
            console.log("isa.assay.xlsx file exist");
            assay = await Xlsx.fromXlsxFile("/arc/assays/"+assayName+"/isa.assay.xlsx");
            isa_assay = await arctrl.XlsxController.Assay.fromFsWorkbook(assay);
            isa_assay.Performers = [person];
            isa_assay.Comment = [comments_m];
            let spreadsheet = arctrl.XlsxController.Assay.toFsWorkbook(isa_assay);
            const outPath = "/arc/assays/"+assayName+"/isa.assay.xlsx";

            console.log(spreadsheet);

            await Xlsx.toFile(outPath,spreadsheet);
         } catch (error) {
          console.log(error);
          
         }
        }else{
          //growth.AddColumn(arctrl.CompositeHeader.characteristic(oa_species), [arctrl.CompositeCell.createTerm(oa_chlamy )]);

          const myAssay = arctrl.ArcAssay.create("myassay", void 0, void 0, void 0, [growth], void 0,[person], [comments_m]);
          // -------- 2. Transform object to generic spreadsheet ----------
          let spreadsheet = arctrl.XlsxController.Assay.toFsWorkbook(myAssay);
          // -------- 3. Write spreadsheet to xlsx file (or bytes) ----------
          const outPath = "/arc/assays/"+assayName+"/isa.assay.xlsx";

          console.log(spreadsheet);

          await Xlsx.toFile(outPath,spreadsheet);
          }
        } catch (err) {
        console.error(err);
        }
    } 


      function showError(text){
        alert(text);
        updateInfo(text,"0")

      }

      function extractCookie(name){
        const cookie = document.cookie;
        const values = cookie.split("; ");
        let value = "";
        values.forEach(e=> { if (e.split("=")[0]===name){ value = e.split("=")[1]} }  );
        return value;
      }

      function softRoute() {
      const urlRoute = window.location.href.split("#");
      const url1 =  urlRoute[0].split("?")[1];
      console.log("submission url is "+ url1);
      try {
        if (url1){        
        const submitData = url1.split("&");
        let submitJSON = {};
        submitData.forEach(e=>
        { submitJSON[e.split("=")[0]] = e.split("=")[1]}
      );
      if (submitData.length <4 ){
        parseInt(submitJSON.elabid.toString())<1000 ? updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, "https://demo.elabftw.net/api/v2/" ) : updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, window.localStorage.elabURL );
      }else{
        updateAll(submitJSON.elabid, submitJSON.elabtoken, submitJSON.datahubtoken, submitJSON.elabURL )
      }
      
      } else {

      }
      try {
          const cookie = document.cookie;
          document.getElementById("elabexperimentid").value = extractCookie("elabid");
          document.getElementById("elabToken").value = extractCookie("elabtoken");
          document.getElementById("datahubToken").value = extractCookie("datahubtoken");
        } catch (error) {
          
        }
      } catch (error) {
        showError("submission URL is wrong, error is " + error+". Please check your URL or remove everything after /elab2arc/")
      }
      
      
      const para = urlRoute.slice(-1)[0];
      switch (para) {
        case "elab":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "arc":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "arcTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
        case "submit":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "updateTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "https://xrzhou.com/elab2arc/":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "http://127.0.0.1:8000/":
          window.location.href = "http://127.0.0.1:8000/elab2arc/"
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          case "":
          document.querySelectorAll('div[name="tab"]').forEach((e) => {
            if (e.id == "elabTab") { e.classList.remove("d-none") }
            else { e.classList.add("d-none") }
          }

          )
          break;
          
        default:

      }
      
      

    }

    async function cloneARC(convert = true) {
      try {
        document.getElementById("loadingModalBtn").click();
        var url;
        const token = document.getElementById("gitpassword").value;
        if (!token) {
          url = document.getElementById("repoURL").value;
          console.log(url)
        } else {
          [begin, end] = document.getElementById("repoURL").value.split("//")
          url = begin + "//oath2:" + token + "@" + end;
          console.log(url);
        }
        let date = Date().replaceAll(" ", "_").replaceAll(":", "-").split("(")[0];
        let dir = "/" + url.split("/").slice(-1)[0] + date
        FS.mkdirSync(dir);
        window.current_file = dir;
        const res = await git.clone({
          fs,
          http,
          dir,
          corsProxy: 'https://cors.isomorphic-git.org',
          url: url,
          ref: 'main',
          singleBranch: true,
          depth: 1,
          force: true,
          onProgress: event => {
            updateLabel(event.phase)
            if (event.total) {
              updateProgressBar(event.loaded / event.total)
            } else {
              //updateIndeterminateProgressBar(event.loaded)
            }
          }
        });
        let tableHTML="";
        const fileList = fs.readdirSync("/");
        fileList.forEach((element, index) => {
          if (!element.endsWith(".json")){
            const fileName = element.split(".git");
          tableHTML += `
                <tr>
                <td>
              `+ fileName[0] + `
                </td>
                <td>
             `+ fileName[1] + `
                </td>
                <td>  
              <button type="button" onclick=" runARC2JSON('`+ element + `')" class="btn btn-primary"> Update ARC </button>
              </td>
            </tr>
            `
          }
          
        });
        document.getElementById("importedARCTable").innerHTML= tableHTML;
        if (convert) {
         
        }
      } catch (error) {
        document.getElementById("a2jNavBtn").click();
        throw showError(error),
        console.error(error);
      }

      loading.hide();

    }
    function updateLabel(phrase) {
      document.getElementById("pbarLabel").innerHTML = phrase;
    }
    function updateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
    function updateIndeterminateProgressBar(progress) {

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:' + progress + '%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
  </script>


  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true" style="z-index:1001">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">

            <div class="form-check" id="submitRepos">
              
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="1" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        Fetch eLabFTW 

                      </label>


                    </div>
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>




                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ena" name="repo">
                      <label class="form-check-label" for="ENA">
                        Clone ARC
                      </label>
                    </div>
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>



                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Update ARC and Resubmit
                      </label>
                    </div>


                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>


              </div>


            
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="Array.from(document.querySelectorAll('input[name=repo]:checked')).forEach((e)=> submitAll(e.id, window.input_json)) ">Submit</button>
        </div>
      </div>
    </div>
  </div>

</body>
<script>

</script>

</html>